---
title: "Analyze: How do Casual Users and Annual Subscribers Differ?"
author: "Andrew Luyt"
date: "2021-07-27"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load data, include=FALSE}
library(tidyverse)
library(lubridate)
library(data.table)
library(sf)
library(here)
library(viridis)
library(ggrepel)

Mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}

x.txt.size = 13  # scale the x axis ticks in many graphs

DATA = here("data/alldata.csv.gz")
df <- fread(
  DATA,
  colClasses = c(start_station_id = 'character',
                 end_station_id = 'character'),
  stringsAsFactors = TRUE,
  showProgress = FALSE
)

# put the factors in convenient order now, else we'll have to do this
# every time we make a plot using the weekday.
df <- df %>%
  mutate(
    weekday = fct_relevel(weekday,
                          c("Monday", "Tuesday", "Wednesday", "Thursday", 
                            "Friday", "Saturday", "Sunday")),
    month = fct_relevel(month, 
                        c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", 
                          "Aug", "Sep", "Oct", "Nov", "Dec")))

# Chicago neighbourhood boundaries as Simple Features. We only need
# the geometry for mapping, all the attributes can be discarded.
boundaries_chi = st_read(here("data/Chicago_Boundaries-Neighborhoods.geojson"),
                         quiet = TRUE)
boundaries_chi <- boundaries_chi %>%
  select(geometry)
```

## Quick descriptive statistics

```{r descriptive statistics, echo=FALSE}
# number of rides, by membership + weekday
df %>% 
  group_by(weekday, member_casual) %>% 
  summarise(n_rides = n())

# trip minutes by membership
df %>% 
  group_by(member_casual) %>% 
  summarise(across(trip_minutes, c(min=min, max=max, mean=mean, median=median, sd=sd)))
```


## Who rides most often?
Members take the majority of rides.

```{r who rides most often, echo=FALSE}
df %>% 
  group_by(member_casual) %>% 
  summarise(n = n()) %>% 
  ggplot(aes(x = member_casual, y = n, fill = member_casual)) +
  geom_col() +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Total number of rides",
       subtitle = paste("Since", lubridate::month(min(df$started_at), label = TRUE),
                        year(min(df$started_at))),
       x = NULL, y = "Rides",
       caption = "Source: Divvy public data") +
  geom_text(aes(label = scales::comma(n)), 
            vjust = 2.1,
            size = 5) +
  theme(axis.text.x = element_text(size = x.txt.size),
        legend.position = "none")
```

On weekends however, casual use approximately doubles and exceeds member use. 

```{r who rides most often 2, echo=FALSE, message=FALSE, fig.width=7}
df %>% 
  group_by(member_casual, weekday) %>% 
  summarise(n = n()) %>% 
  ggplot(aes(x = weekday, y = n, fill = member_casual)) +
  geom_col(position = "dodge") +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Total number of rides on each day of the week",
       subtitle = paste("Since", lubridate::month(min(df$started_at), label = TRUE),
                        year(min(df$started_at))),
       x = NULL, y = "Rides",
       caption = "Source: Divvy public data") +
  theme(axis.text.x = element_text(),
        legend.title = element_blank())
```

Breaking down the number of rides by month, we can see that while the season
is important for all riders, casual users are much less willing to ride in
the winter months. December to February, the system sees very little casual use.

```{r who rides most often 3, echo=FALSE, message=FALSE, fig.width=7}
df %>% 
  filter(started_at >= "2020-07-01") %>% 
  group_by(member_casual, month) %>% 
  summarise(n = n()) %>% 
  ggplot(aes(x = month, y = n, fill = member_casual)) +
  geom_col(position = "dodge") +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Total number of rides each month",
       subtitle = "Since July 2020",
       x = NULL, y = "Rides",
       caption = "Source: Divvy public data") +
  theme(axis.text.x = element_text(),
        legend.title = element_blank())
```

## How do they differ on type of bike ridden?
Casuals are more likely to choose a docked bike and less likely to choose a
classic bike.

**This is confusing**.  The divvy website lists two types of bikes, **classic**
and **electric bike.** What is a **docked bike**?

```{r differ on bike type, echo=FALSE}
# df %>%
#   group_by(member_casual, rideable_type) %>%
#   summarise(n = n(), .groups = "drop_last") %>%
#   mutate(percentage = n / sum(n) * 100)

df %>%
  ggplot(aes(y = member_casual, fill = rideable_type)) +
  geom_bar(position = "fill") +
  scale_x_continuous(labels = scales::comma) +
  labs(title="What kind of bikes are being chosen?", subtitle="Casuals vs Members",
       y=NULL, x = 'Proportion',
       caption = "Source: Divvy public data")
```

## How do trip distances vary?
This is a bit surprising - the average trip is about the same distance for
both classes of users.  For this analysis we've removed trips that start and end 
at the same station since we have no indication how long the trip was.

```{r avg trip distance}
df %>% 
  filter(is_round_trip == 'a to b') %>% 
  group_by(member_casual) %>% 
  summarise(mean_trip_distance = mean(trip_distance)) %>% 
  ggplot(aes(member_casual, mean_trip_distance, fill = member_casual)) +
  geom_col() +
  labs(title = "Average trip distance (Km)",
       subtitle = "Straight-line distance, 'as the crow flies'",
       caption = "Source: Divvy public data",
       x = NULL, y = "Kilometers") +
  geom_text(aes(label = round(mean_trip_distance, digits = 1)), 
            vjust = 2.1,
            size = 5) +
  theme(legend.position = "none",
        axis.text.x = element_text(size = x.txt.size))
```
Not much difference by weekday.

```{r avg trip distance 2}
df %>% 
  filter(is_round_trip == 'a to b') %>% 
  group_by(member_casual, weekday) %>% 
  summarise(mean_trip_distance = mean(trip_distance)) %>% 
  ggplot(aes(weekday, mean_trip_distance, fill = member_casual)) +
  geom_col(position = "dodge") +
  labs(title = "Average trip distance (Km)",
       subtitle = "Straight-line distance, 'as the crow flies'",
       caption = "Source: Divvy public data",
       x = NULL, y = "Kilometers") 
```

```{r avg trip distance 3}
df %>% 
  filter(is_round_trip == 'a to b') %>% 
  group_by(member_casual, month) %>% 
  summarise(mean_trip_distance = mean(trip_distance)) %>% 
  ggplot(aes(month, mean_trip_distance, fill = member_casual)) +
  geom_col(position = "dodge") +
  labs(title = "Average trip distance (Km)",
       subtitle = "Straight-line distance, 'as the crow flies'",
       caption = "Source: Divvy public data",
       x = NULL, y = "Kilometers") 
```

For this analysis we've 
removed trips that start and end 
at the same station since they have an apparent distance of zero. We believe
it's likely that pleasure cruises make up a large portion of these rides. We'll
examine this idea in a section further below.

```{r}
df %>% 
  filter(is_round_trip == 'round trip') %>% 
  group_by(member_casual) %>% 
  summarise("Possible pleasure cruises" = n(),
            "Avg trip minutes" = round(mean(trip_minutes), 0)) %>% 
  rename("Rider Type" = member_casual)
```

## How much *time* is spent on an average ride?
Casuals ride more than twice as long as members, on average.  There isn't
much variation in ride duration over the week other than a slight increase
over the weekend.

```{r mean ride duration, echo=FALSE}
df %>% 
  group_by(member_casual) %>% 
  summarise(mean_ride_length = mean(trip_minutes)) %>% 
  ggplot(aes(member_casual, mean_ride_length, fill = member_casual)) +
  geom_col() +
  labs(title = "Average ride duration (minutes)",
       x = NULL, y = "Minutes",
       caption = "Source: Divvy public data") +
  geom_text(aes(label = round(mean_ride_length, digits = 1)), 
            vjust = 2.1,
            size = 5) +
  theme(legend.position = "none",
        axis.text.x = element_text(size = x.txt.size))
```

Seasonally, casual rides have a large amount of variation. The small number of
winter trips taken tend to be short - half the length of rides at the peak of summer.

```{r mean ride duration 2, echo=FALSE}
df %>% 
  group_by(member_casual, month) %>% 
  summarise(mean_ride_length = mean(trip_minutes)) %>% 
  ggplot(aes(month, mean_ride_length, fill = member_casual)) +
  geom_col() +
  labs(title = "Average ride duration (minutes)",
       x = NULL, y = "Minutes",
       caption = "Source: Divvy public data") +
  geom_text(aes(label = round(mean_ride_length, digits = 0)), 
            vjust = 2.1,
            size = 4) +
  theme(legend.position = "none",
        axis.text.x = element_text(size = x.txt.size))
```

## Pleasure cruises?

Earlier we noted the possibility of about 10% of rides being round-trip
pleasure cruises, starting and ending at the same station, likely near the
rider's home. The two graphs below provide evidence for this idea.

If our hypothesis is correct, the percentage of this type of ride should shrink
in winter and grow in summer and be mostly confined to casual users.  This
first graph shows exactly this pattern.

```{r pleasure cruises}
df %>% 
  group_by(month, member_casual, is_round_trip) %>% 
  summarise(n = n()) %>% 
  mutate(percent_of_rides = n / sum(n) * 100) %>% 
  filter(is_round_trip == "round trip") %>%
  ggplot(aes(x = month, y = percent_of_rides, fill = member_casual)) +
  geom_col() +
  facet_wrap(~member_casual, ncol = 2) +
  labs(title = "Pleasure cruises over the seasons",
       subtitle = "Percentage of all trips starting and ending at the same station",
       caption = "Source: Divvy public data",
       x = NULL, y = "Percent of all trips") +
  theme(legend.position = "none")
```

Second, if our idea is correct we should also see trip duration becoming longer
in winter and shorter in summer. This should strongly affect casual users but
have little effect on members, who have a 45-minute time limit.  This graph
demonstrates this pattern as well.

```{r pleasure cruises 2}
df %>% 
  group_by(month, member_casual, is_round_trip) %>% 
  summarise(avg_ride_minutes = mean(trip_minutes)) %>% 
  filter(is_round_trip == "round trip") %>%
  ggplot(aes(x = month, y = avg_ride_minutes, fill = member_casual)) +
  geom_col() +
  facet_wrap(~member_casual, ncol = 2) +
  labs(title = "Duration of pleasure cruises over the seasons",
       caption = "Source: Divvy public data",
       x = NULL, y = "Minutes") +
  theme(legend.position = "none")
```

## Ride speed
We've seen that casuals and members ride about the same distances, but members
spend less time on the bikes. The graph below shows that members are about
30% faster on average.

We've removed trips that start and end at the same station, since their recorded
trip distance is 0.

```{r}
df %>% 
  filter(is_round_trip == 'a to b') %>%
  group_by(member_casual) %>% 
  summarise(mean_kph = mean(trip_kph)) %>% 
  ggplot(aes(member_casual, mean_kph, fill = member_casual)) +
  geom_col() +
  labs(title = "Mean trip speed (Kph)",
       subtitle = "Members ride about 30% faster",
       x = NULL, y = "Kilometers per hour",
       caption = "Source: Divvy public data") +
  geom_text(aes(label = round(mean_kph, digits = 1)), 
            vjust = 2.1,
            size = 5) +
  theme(legend.position = "none",
        axis.text.x = element_text(size = x.txt.size))
```

## Members ride more often, casuals ride longer: who rides the most total minutes?
Casuals spend more time using the bicycles.

```{r echo=FALSE}
df %>% group_by(member_casual) %>% 
  summarise(total_minutes = sum(trip_minutes)) %>% 
  ggplot(aes(member_casual, total_minutes, fill= member_casual)) +
  geom_col() +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Who is in the saddle the longest?",
       subtitle=paste("Total minutes since", 
                      lubridate::month(min(df$started_at), label = TRUE),
                      year(min(df$started_at))),
       x = NULL,
       y = "Total Minutes",
       caption = "Source: Divvy public data") +
  stat_summary(fun = sum, 
               geom="text", 
               aes(label=scales::comma(total_minutes)), vjust = 2, size=5) +
  theme(legend.position = "none", 
        axis.text.x = element_text(size=x.txt.size))
```


## What is the distribution of ride durations?

A quick examination shows a few notable items:

- Casuals have a higher mean and median trip time. i.e. they tend to take
longer trips
- The difference is amplified in the particularly long trips
  - compare the 95th percentile trip time. 5% of casuals take trips longer
  than 1:50!

**NB: Divvy's policies (starting in 2018) limit members to 45 minutes on the
bike at one time (up from 30 minutes.)  This artificial limit is almost
certainly the cause of these observations. Anyone, members included, who wish
a long cruise have to purchase a day pass.**
  
```{r trip length details, echo=FALSE, message=FALSE}
df %>% 
  group_by(member_casual) %>% 
  select(trip_minutes) %>% 
  summarise(mean = mean(trip_minutes),
            median = median(trip_minutes),
            quantiles = quantile(trip_minutes, c(0.25, 0.75, 0.95)),
            q = c(0.25, 0.75, 0.95))
```

From above we see there is a **wide** range of trip lengths, with most being
short and a small number being over an hour. We will trim off the longest 5% of
trips so we can see the typical pattern of ride length.

**One observation is that casual riders make up almost all trips longer than 40 
minutes.**  Online research shows that in 2018, Divvy extended the maximum
ride length for members to 45 minutes (up from 30). Longer rides incur a fee.

One question to arise from this: what sort of bike is most comfortable for
long trips, and which are better for short ones?  Do members tend to choose
lighter, speedier bikes and do casuals prefer bikes with more comfort?

```{r trip duration histogram}
df %>% 
  group_by(member_casual) %>%  # IMPORTANT! Trim the top 5% of EACH GROUP, separately
  filter(trip_minutes < quantile(trip_minutes, 0.95)) %>% 
  ungroup() %>% 
  ggplot(aes(x = trip_minutes, fill = member_casual, color = member_casual)) +
  geom_histogram(bins = 40, alpha = 0.7) +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Ride durations",
       x = "Minutes", y = "Count of rides",
       caption = "Source: Divvy public data") +
  annotate(geom = "text", x = 70, y = 200000, label = "Members pay a surcharge if\n riding more than 45 minutes") +
  annotate(geom = "curve", x = 50, y = 160000, xend = 39, yend = 16000, 
           curvature = 0.1, arrow = arrow(length = unit(.02, "npc"))) +
  theme(legend.title = element_blank())
```

## Ride duration, by weekday

We see an unsurprising distribution of trip durations over the week: a slight 
increase over the weekend, with casual riders having showing a larger
difference.
```{r tuesday oddity}
df %>% 
  group_by(weekday, member_casual) %>% 
  summarise(mean_ride_length = mean(trip_minutes)) %>% 
  ggplot(aes(weekday, mean_ride_length, fill=member_casual)) +
  geom_col(position = position_dodge(width = 0.4), alpha = 0.8) + 
  labs(title = "Average Ride lengths over the week",
       x = NULL, y = "Average minutes",
       caption = "Source: Divvy public data") +
  theme(legend.title = element_blank())
```

## Number of trips by day of the week
We see here that:

- Member use is fairly steady through the week
- Casual use increases on Friday and nearly doubles through the weekend.

We can take this as more evidence that members are often commuting,
whereas casuals are primarily riding for other reasons (enjoyment, exercise?)

```{r day of week, echo=FALSE}
df %>%
  ggplot(aes(weekday, fill = member_casual)) +
  geom_bar(position = position_dodge(width = 0.5), alpha = 0.8) +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Total Number of rides, by day",
       x=NULL, y = "Rides",
       caption = "Source: Divvy public data") +
  theme(legend.title = element_blank())
```

## Trips volume trend over the last year

- There is an enormous seasonal variation, from a low of 15 rides to a high of
almost 20,000 in one day.
- The trend in 2021 is for higher volume than 2020
- Casual membership seems to be rising more sharply in 2021
```{r daily trips, message=FALSE, echo=FALSE}
df %>% 
  group_by(date(started_at), member_casual) %>% 
  summarise(n_rides = n()) %>% 
  rename(date = 1) %>% 
  ggplot(aes(x = date, y = n_rides, color = member_casual)) +
  geom_point(alpha = 0.3) +
  geom_smooth(size=2, se = FALSE) + 
  labs(title = "Seasonal variation in bike usage",
       subtitle = "Daily trip volume, 2020-2021", 
       x = 'Date', y = "Rides",
       caption = "Source: Divvy public data") +
  theme(legend.title = element_blank())
```

## Do weekends matter?
Yes, but only for casuals and not in winter.

```{r do weekends matter, message=FALSE, echo=FALSE}
df %>% 
  group_by(date(started_at), member_casual, weekend_weekday) %>% 
  summarise(n_rides = n()) %>% 
  rename(date = 1) %>% 
  ggplot(aes(x = date, y = n_rides)) +
  geom_point(alpha=0.2) +
  geom_smooth(aes(color = weekend_weekday), se = FALSE, size = 2) + 
  facet_wrap(~member_casual) +
  scale_color_brewer(palette="Set1") +
  labs(title = "Trip Volume: Weekend vs Weekday", 
       subtitle = "Weekends are king for casuals", 
       x = 'Date', y = "Rides",
       color = "Weekend?",
       caption = "Source: Divvy public data") +
  guides(color = guide_legend(reverse = TRUE))   # reverse legend order, TRUE first
```


## Do they differ in *what hour* rides are taken?
Not much. There seems to be a slight tendency for casuals to start their rides later.
The tendency is similar for ending times (not shown.)

```{r hour of trip start, echo=FALSE}
df %>% 
  ggplot(aes(x=member_casual, y=hour(started_at), fill = member_casual)) +
  geom_boxplot() +
  labs(x = NULL, y = "Hour the trip started", title = "When do trips start?",
       caption = "Source: Divvy public data")
```


## Hour of trip start, in detail
Lending more weight to the 'members commute more often' hypothesis we see
two jumps in member activity, both starting around morning and evening
commute times.  Casual users have a much smoother increase in trips
as the day goes on. Two possible interpretations are that 
casuals are using a bike for their commute less often,
or casual users tend to have non-typical start times for their job.

```{r hour of trip start detailed, echo=FALSE}
df %>% ggplot(aes(hour(started_at), fill=member_casual)) +
  geom_bar(position = position_dodge(width=0.7), alpha = 0.8) +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "How many rides start in each hour?",
       x = "Hour", y = NULL,
       caption = "Source: Divvy public data") +
  annotate("text", x = 5, y = 220000, label = "Morning rush hour, members only!") +
  annotate("curve", x = 1, y = 210000, xend = 5.5, yend = 120000,
           curvature = 0.1, arrow = arrow(length = unit(0.07, "npc"))) +
  theme(legend.title = element_blank())
```


## Are some stations preferred by casuals?
Dramatically so! Some stations are 100% casual use and others are near-zero!
The median station is 42% casual use.

```{r station use, echo=FALSE}
df %>% 
  group_by(start_station_id, member_casual) %>% 
  summarise(n = n(), .groups = 'drop_last') %>% 
  mutate(percentage = n / sum(n) * 100) %>% 
  filter(member_casual == "casual") %>% 
  ggplot(aes(percentage)) + 
  geom_histogram(bins = 30, fill='deepskyblue') +
  labs(title="Distribution of station use",
       subtitle = "Stations vary from 100% casual to near-zero!",
       x = 'Percentage of casuals',
       y = 'Number of stations',
       caption = "Source: Divvy public data")
```

## Which stations do casuals use?

We'll look at this question in two parts.  **First** we'll sort the stations
by popularity (number of trips that start there) and colour the points by the
proportion of the type of user. **Second** we will plot these stations on a
map of Chicago.

**First**: station popularity. We can extract three main insights from the 
graph below:

- Overall, most stations are used primarily by members
- The least popular stations are dominated by casual use
- A few of the city's most popular stations are over 75% casual use
  - These might make excellent targets for any pilot programs targeting casual
  users

```{r station popularity and use, message=FALSE}
df %>% 
  group_by(start_station_id, member_casual) %>% 
  summarise(n = n()) %>% 
  mutate(total_trips = sum(n),
         p_casual = n / total_trips,
         mostly_casual = factor(p_casual > .5,
                                levels = c(TRUE, FALSE),
                                labels = c("Mostly casual", "Mostly members"))) %>% 
  filter(member_casual == 'casual') %>% 
  select(start_station_id, p_casual, total_trips, mostly_casual) %>% 
  arrange(total_trips) %>% 
  filter(total_trips > 100) %>% # remove nearly unused stations (some might be obsolete?)
  ggplot(aes(total_trips, p_casual)) +
  geom_point(aes(color = mostly_casual)) +
  geom_smooth() +
  scale_x_log10(breaks = NULL, name = "(-)     Station Popularity     (+)") +
  scale_y_continuous(labels = scales::percent) +
  annotate("text", x = 600, y = 0.95, 
           label = "Least popular") +
  annotate("text", x = 8000, y = 0.95, 
           label = "Most popular") +
  annotate("curve", x = 600, y = 0.9, xend = 140, yend=.8, curvature = -0.1,
           arrow = arrow(length = unit(0.04, "npc"))) +
  annotate("curve", x = 8000, y = 0.9, xend = 25000, yend=.75, curvature = 0.1,
           arrow = arrow(length = unit(0.04, "npc"))) +
  labs(title = "Station popularity and typical users",
       subtitle = "The least and most popular stations are used casually",
       y = "Casual use",
       caption = "Source: Divvy public data") +
  theme(legend.title = element_blank())
```



## Plot stations on the map
ideas:

- Size of dot varies with station popularity
- the colour varies with the proportion of users (by trip start) who are casuals. 
  - First step: mostly_casual to colour the stations with binary scheme

```{r mapping the dataset, echo=FALSE, message=FALSE}

x2 <- df %>% 
  # slice_sample(n = 1000000) %>% 
  group_by(start_lng_sector, start_lat_sector, member_casual) %>% 
  summarise(avg_trip_mins = mean(trip_minutes), n_trips_sector = n()) %>% 
  filter(n_trips_sector > 4)  # remove some weird outliers

# use the summary you just calculated
# for a heatmap use bin2d and the identity stat -----------------------------
ggplot(boundaries_chi, aes()) + 
  geom_sf() +
  geom_bin2d(data = x2, stat = 'identity',# bins=c(25,50),
             mapping = aes(start_lng_sector, start_lat_sector, fill= avg_trip_mins),
             alpha = 1) +
  scale_fill_viridis(option = 'plasma') +
  facet_wrap(~member_casual) +
  labs(title = "Length of trips starting here")
```

```{r mapping the dataset 2, echo=FALSE, message=FALSE}
x3 <- df %>% 
  # slice_sample(n = 1000000) %>% 
  group_by(end_lng_sector, end_lat_sector, member_casual) %>% 
  summarise(avg_trip_mins = mean(trip_minutes), n_trips_sector = n()) %>% 
  filter(n_trips_sector > 4)  # remove some weird outliers

# heatmap: use bin2d and the identity stat -----------------------------
ggplot(boundaries_chi, aes()) + 
  geom_sf() +
  geom_bin2d(data = x3, stat = 'identity', bins=c(25,50),
             mapping = aes(end_lng_sector, end_lat_sector, fill= avg_trip_mins),
             alpha = 1) +
  scale_fill_viridis(option = 'plasma') +
  facet_wrap(~member_casual) +
  labs(title = "Length of trips ending here")
```

```{r mapping the dataset 3, echo=FALSE, message=FALSE}
# let the geom (hexbin, 2d density, count) do the aggregation from raw lng/lat
boundaries_chi %>% ggplot(aes()) + 
  geom_sf() +
  geom_bin2d(data = df, mapping = aes(start_lng, start_lat), bins=c(25,50)) +
  scale_fill_viridis(option = 'plasma') +
  facet_wrap(~member_casual) +
  theme(panel.background = element_rect(fill = "white")) +
  labs(title="Number of trips started in this area")
```
```{r mapping the dataset 4, echo=FALSE, message=FALSE}
# TRIP ENDS
ggplot(boundaries_chi, aes()) + 
    geom_sf() +
    geom_bin2d(data = df, mapping = aes(end_lng, end_lat),  bins=c(25,50)) +
  scale_fill_viridis(option = 'plasma') +
  facet_wrap(~member_casual) +
  theme(panel.background = element_rect(fill = "white")) +
  labs(title="Number of trips ended in this area")
```
```{r mapping the dataset 5, echo=FALSE, message=FALSE}
# TRIP starts and ends in the same station
# see how there is a huge spike of round tripping casuals right in that one area
pleasure_cruises <- df %>% 
  filter(is_round_trip == 'round trip', member_casual == 'casual')

ggplot(boundaries_chi, aes()) + 
  geom_sf() +
  # geom_hex(data = pleasure_cruises,
  #           mapping = aes(end_lng, end_lat)) +
  geom_bin2d(data = pleasure_cruises, mapping = aes(end_lng, end_lat), bins=c(25,50)) +
  scale_fill_viridis(option = 'plasma') +
  # facet_wrap(~member_casual) +
  theme(panel.background = element_rect(fill = "white")) +
  labs(title="Where do casual pleasure cruises start?")
rm(pleasure_cruises)
```

```{r mapping the dataset 6, echo=FALSE, message=FALSE}
# TRIP starts and ends in different places: map start point
a_to_b <- df %>% 
  filter(is_round_trip == 'a to b')
ggplot(boundaries_chi, aes()) + 
  geom_sf() +
  # geom_hex(data = a_to_b,
  #          mapping = aes(start_lng, start_lat)) +
  geom_bin2d(data = a_to_b, mapping = aes(start_lng, start_lat), bins=c(25,50)) +
  scale_fill_viridis(option = 'plasma') +
  facet_wrap(~member_casual) +
  theme(panel.background = element_rect(fill = "white")) +
  labs(title="Number of trips started here and ending elsewhere")
# TRIP starts and ends in different places: map END point
ggplot(boundaries_chi, aes()) + 
  geom_sf() +
  # geom_hex(data = a_to_b,
  #          mapping = aes(end_lng, end_lat)) +
  geom_bin2d(data = a_to_b, mapping = aes(end_lng, end_lat), bins=c(25,50)) +
  scale_fill_viridis(option = 'plasma') +
  facet_wrap(~member_casual) +
  theme(panel.background = element_rect(fill = "white")) +
  labs(title="Number of trips started elsewhere & ended here")
rm(a_to_b)
```
```{r mapping the dataset 7, echo=FALSE, message=FALSE}
# Facet on membership & is_round_trip
# 42 & 25 are the number of rectangular sectors
ggplot(boundaries_chi, aes()) + 
  # geom_sf() +
  geom_bin2d(data = df, mapping = aes(start_lng, start_lat),  bins=c(25,50)) +
  scale_fill_viridis(option = 'plasma') +
  facet_wrap(~member_casual + is_round_trip, scales = 'free', ) +
  theme(panel.background = element_rect(fill = "white"), aspect.ratio = 42/25) +
  labs(title="Number of trips that started here")
ggplot(boundaries_chi, aes()) + 
  # geom_sf() +
  geom_bin2d(data = df, mapping = aes(end_lng, end_lat), bins=c(25,50)) +
  scale_fill_viridis(option = 'plasma') +
  facet_wrap(~member_casual + is_round_trip, scales = 'free', ) +
  theme(panel.background = element_rect(fill = "white"), aspect.ratio = 42/25) +
  labs(title="Number of trips that ended here")
```
```{r mapping the dataset 8, echo=FALSE, message=FALSE, warning=FALSE}
# make a station density map
# create some convenient tibbles for mapping.
# Bike stations with location, trips, mean duration
stations <- df %>% 
  group_by(start_station_id, member_casual) %>% 
  summarise(start_station_name = Mode(start_station_name),
            station_lng = mean(start_lng),  # there is GPS error in coords
            station_lat = mean(start_lat),
            n_trips = n(),
            mean_duration = mean(trip_minutes)) %>% 
  filter(n_trips > 10)  # remove stations w/o enough data
# RECTANGULAR SECTORS which bin bike stations inside them
stations_sectored <- df %>% 
  group_by(start_lng_sector, start_lat_sector, member_casual) %>% 
  summarise(n_trips = n(),
            mean_duration = mean(trip_minutes)) %>% 
  filter(n_trips > 10)
```
```{r mapping the dataset 8.5}
# Let bin2d perform the binning and give us a heatmap
ggplot(boundaries_chi, aes()) +
  geom_sf() +
  geom_bin2d(data = stations, mapping = aes(station_lng, station_lat), bins=c(25,50)) +
  scale_fill_viridis(option= 'turbo') +
  labs(title = 'Station density')
```
```{r mapping the dataset 12, echo=FALSE, message=FALSE}
# Station density map again, simpler?
# Does the counts (rides starting in a bin) quite nicely.
boundaries_chi %>% ggplot() +
  geom_sf() +
  geom_bin2d(data = stations, aes(x = station_lng, y = station_lat),
             bins = c(25,50)) +
  scale_fill_viridis(option= 'turbo') +
  labs(title = "Station density")
```

```{r mapping the dataset 13, echo=FALSE, message=FALSE}
# What I'd like to do though is calculate a stat for each CALCULATED BIN.
# Like, the program bins all the coordinates and I want a mean of
# mean_duration for all observations in the bin. Right now the default
# is just to count observations in the bin.
boundaries_chi %>% ggplot() +
  geom_sf() +
  geom_hex(data = stations, aes(x = station_lng, y = station_lat), bins = c(18,24)) +
  scale_fill_viridis(option= 'turbo') +
  labs(title = "Station density")
```
```{r mapping the dataset 9, echo=FALSE, message=FALSE}
# trip durations map
# individual stations - 'scatterplot'
ggplot(boundaries_chi, aes()) +
  geom_sf() +
  geom_point(data = stations,
             mapping = aes(station_lng, station_lat, color = mean_duration)) +
  scale_color_viridis(option= 'plasma') +
  labs(title = 'Mean duration of trips started here')
```
```{r mapping the dataset 10, echo=FALSE, message=FALSE}
# stations binned into sectors
ggplot(boundaries_chi, aes()) +
  geom_sf() +
  geom_bin2d(data = stations_sectored, stat = 'identity',  bins=c(25,50),
             mapping = aes(start_lng_sector, start_lat_sector, fill = mean_duration)) +
  scale_fill_viridis(option= 'turbo') +
  labs(title = 'Mean duration of trips started here')

# ggplot(boundaries_chi, aes()) +
#   geom_sf() +
#   geom_point(data = stations_sectored,
#              mapping = aes(start_lng_sector, start_lat_sector, col = mean_duration),
#              size=2) +
#   scale_color_viridis(option= 'turbo') +
#   labs(title = 'Mean duration of trips started here')
```


```{r mapping the dataset 14, echo=FALSE, message=FALSE}
# Sorting the data by p_trips_casual controls the order that dots are plotted
# in the map in the next code block. This is important because of overplotting.
# When stations are plotted in this order, the last stations to be plotted
# are on top. 
# The business task is to increase casual use, and this method ensures we 
# see the high casual use stations when the map is crowded. 
stations_users <- stations %>% 
  group_by(start_station_id) %>%
  mutate(p_trips_casual = n_trips / sum(n_trips),
         n_trips_station = sum(n_trips)) %>% 
  filter(member_casual == "casual") %>% 
  rename(n_trips_casual = n_trips) %>% 
  arrange(p_trips_casual)

# Map station usage: colour stations by casual use percentage (ride start)
boundaries_chi %>% ggplot() +
  geom_sf() +
  geom_point(data = stations_users, 
             mapping = aes(x = station_lng, y = station_lat,
                           color = p_trips_casual)) +
  scale_color_viridis(option = "turbo", labels = scales::percent) +
  labs(title = "Casual usage at each station",
       color = "Casual use\n")

# Map the casual hot spots: stations over 75% casual use
boundaries_chi %>% ggplot() +
  geom_sf() +
  geom_point(data = stations_users, 
             mapping = aes(x = station_lng, y = station_lat, 
                           size = n_trips_station,
                           color = p_trips_casual > .7)) +
  scale_size_continuous(range = c(1, 8)) +
  # scale_color_viridis(option = "jet", discrete = TRUE) +
  scale_color_discrete(type=c("deepskyblue4", "red")) +
  # scale_color_brewer(palette = "Set1", direction = -1) +
  guides(color = guide_legend(reverse = TRUE)) +  # reverse legend order, TRUE first
  labs(title = "Highlight stations over 70% casual use",
       color = "Over 70% casual use")
```
```{r mapping the dataset 15, echo=FALSE, message=FALSE}
# Map the BUSY casual hot spots: stations over 75% casual use and > 5000 trips
NRIDES = 500
PCASUAL = 0.7
stations_users <- stations %>% 
  filter(n_trips > NRIDES) %>% 
  group_by(start_station_id) %>%
  mutate(p_trips_casual = n_trips / sum(n_trips),
         n_trips_station = sum(n_trips)) %>% 
  filter(member_casual == "casual",
         p_trips_casual > PCASUAL) %>% 
  rename(n_trips_casual = n_trips) %>% 
  arrange(p_trips_casual)

boundaries_chi %>% ggplot() +
  geom_sf() +
  geom_point(data = stations_users, 
             mapping = aes(x = station_lng, y = station_lat,
                           size = n_trips_station),
             fill = 'red',
             color = 'black',
             shape = 21) +
  scale_size_continuous(range = c(2.5, 8)) +
  labs(title = "Casual use hot spots",
       subtitle = paste("Stations over ", NRIDES, " rides and ", PCASUAL * 100, "% casual use", sep = ""),
       size = "Number of trips") +
  ylim(c(41.77, 42.01)) +
  xlim(c(-87.8, -87.57))
```

### Zoom in
These stations are all on and around the waterfront between Soldier Field and
Navy Pier. They represent what is easily the most popular casual use desination
and usage pattern anywhere in the city.

```{r mapping the dataset 16, echo=FALSE, message=FALSE}

# Get the top 10 busiest casual stations.
top10 <- stations_users %>% 
  ungroup() %>% 
  slice_max(n_trips_casual, n = 10) %>% 
  arrange(desc(station_lat)) %>% 
  select(start_station_name, station_lng, station_lat, n_trips_casual)

boundaries_chi %>% ggplot() +
  geom_sf() +
  geom_point(data = stations_users, 
             mapping = aes(x = station_lng, y = station_lat,
                           size = n_trips_casual),
             fill = 'red',
             color = 'black',
             shape = 21) +
  geom_label_repel(data = top10, 
            mapping = aes(x = station_lng, y = station_lat, label = start_station_name),
            nudge_x = -0.005,
            box.padding = .5) +
  scale_size_continuous(range = c(4, 10)) +
  labs(title = "Casual use hot spots on the waterfront",
       subtitle = "The most popular casual use destinations in Chicago",
       size = "Number of trips") +
  theme_bw() +
  theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank()) +
  ylim(c(41.86, 41.90)) +
  xlim(c(-87.67, -87.59))
```



## Average rider motion by hour
Here we'll examine the overall traffic flow: as the hours go by, do riders tend
to ride in a particular direction?  **Yes!** Overall it
seems like there is a daily tendency for riders (and bicycles) to move
northwest.

### TODO: make interpretable with distance
This has connections with how Divvy may have to shuttle bikes around at night
to ensure the busy stations have bikes.

- the average rider (and bike!) moves X Km west by northwest
- overall, traffic moves X Km west by northwest

```{r create motion vectors}
angle_from_x_axis <- function(y,x) {
  angle <- atan(y/x)
  if (x<0) {
    angle <- angle + pi
  } else if (x>=0 & y<0) {
    angle <- angle + 2*pi
  } 
  angle * 180 / pi
}
# trend over the entire dataset
overall_vec <- df %>% 
  group_by(member_casual) %>% 
  summarize(x = sum(trip_delta_x), 
            y = sum(trip_delta_y),
            mean_x = mean(trip_delta_x),
            mean_y = mean(trip_delta_y),
            magnitude = sqrt(x^2 + y^2),
            angle = angle_from_x_axis(y,x))
overall_vec
```

The overall trend is for trips to go northwest. The averaged traffic flow over
the dataset represents about 200,000km of travel to the northwest.

## Monthly variation
```{r create motion vectors by month}
# monthly trends
month_vec <- df %>% 
  group_by(member_casual,
           month = lubridate::month(started_at, label = TRUE)) %>% 
  summarize(x = sum(trip_delta_x), 
            y = sum(trip_delta_y),
            mean_x = mean(trip_delta_x),
            mean_y = mean(trip_delta_y),
            magnitude = sqrt(x^2 + y^2),
            angle = angle_from_x_axis(y,x))

ggplot(month_vec, aes(x=0, y=0, xend=x, yend=y, color=member_casual)) +
  geom_hline(yintercept = 0, color = 'gray80') +
  geom_vline(xintercept = 0, color = 'gray80') +
  theme_gray() +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_blank()) +
  geom_segment(arrow = arrow(length = unit(0.1, "npc"))) +
  facet_wrap(~month) +
  labs(title = "Overall traffic direction and strength, by month")
```

The overall traffic flow for members and casuals is pretty similar. Over the 
months only the volume has a large change. We'll have to break the data
down further to gain more insight.

## Weekday variation
```{r create motion vectors weekday}
# monthly trends
weekday_vec <- df %>% 
  group_by(member_casual, weekday) %>% 
  summarize(x = sum(trip_delta_x), 
            y = sum(trip_delta_y),
            mean_x = mean(trip_delta_x),
            mean_y = mean(trip_delta_y),
            magnitude = sqrt(x^2 + y^2),
            angle = angle_from_x_axis(y,x))

ggplot(weekday_vec, aes(x=0, y=0, xend=x, yend=y, color=member_casual)) +
  geom_hline(yintercept = 0, color = 'gray80') +
  geom_vline(xintercept = 0, color = 'gray80') +
  theme_gray() +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_blank()) +
  geom_segment(arrow = arrow(length = unit(0.1, "npc"))) +
  facet_wrap(~weekday) +
  labs(title = "Overall traffic direction and strength, by weekday")
```

Casuals show the biggest change from the "commuting" pattern on the weekend.
Still, this is not very insightful. We'll continue to break down the traffic
flow.

## Hourly variation

We compute an estimate of the overall flow of traffic (direction and distance) 
for every trip taken each hour.  We see the strong signals for the morning
and evening commutes, with the evening being larger.  This probably leads to
bicycles being distributed over the city unequally, with a bias towards the
northwest.

*Technical note: This is done by adding the
vectors of every trip up to compute the 'overall trip' during that hour*

```{r create motion vectors hourly}
# monthly trends
hourly_vec <- df %>% 
  group_by(member_casual, hour = lubridate::hour(started_at)) %>% 
  summarize(x = sum(trip_delta_x), 
            y = sum(trip_delta_y),
            mean_x = mean(trip_delta_x),
            mean_y = mean(trip_delta_y),
            magnitude = sqrt(x^2 + y^2),
            angle = angle_from_x_axis(y,x))

ggplot(hourly_vec, aes(x=0, y=0, xend=x, yend=y, color=member_casual)) +
  geom_hline(yintercept = 0, color = 'gray80') +
  geom_vline(xintercept = 0, color = 'gray80') +
  theme_gray() +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_blank()) +
  geom_segment(arrow = arrow(length = unit(0.1, "npc"))) +
  facet_wrap(~hour) +
  labs(title = "Overall traffic direction and strength, by hour")
```

That's interesting. Over 24 hours, the overall traffic flow rotates, grows, and
shrinks a lot.  Between 6-8am we see the morning commute, and between 4-6pm there
is a similar signal in the opposite direction for the evening commute. It appears
the evening commute is larger.  It's also interesting to note that casual
traffic is actually larger than member traffic between the hours of 11am and 1pm.

Still, there isn't a large difference between casuals and members. Let's break
it down further.




Members and casuals seem to have different hourly patterns. It doesn't change
much over the months.

```{r create motion vectors month-weekday}
# monthly trends
month_weekday_vec <- df %>% 
  group_by(member_casual,
           month = lubridate::month(started_at, label = TRUE),
           weekday) %>% 
  summarize(x = sum(trip_delta_x), 
            y = sum(trip_delta_y),
            mean_x = mean(trip_delta_x),
            mean_y = mean(trip_delta_y),
            magnitude = sqrt(x^2 + y^2),
            angle = angle_from_x_axis(y,x))

ggplot(month_weekday_vec, aes(x=0, y=0, xend=x, yend=y, color=member_casual)) +
  geom_hline(yintercept = 0, color = 'gray80') +
  geom_vline(xintercept = 0, color = 'gray80') +
  theme_gray() +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_blank()) +
  geom_segment(arrow = arrow(length = unit(0.1, "npc"))) +
  facet_wrap(~month) +
  labs(title = "Overall traffic direction and strength, by month and weekday")
```

Overall traffic flow is consistently to the northwest except in winter.
There is also a large signal for what looks like one day in May for casual users. 
Let's investigate.

```{r}
df %>% 
  mutate(daynum = lubridate::day(started_at)) %>% 
  filter(lubridate::month(started_at) == 5,
         lubridate::year(started_at) == 2020) %>% 
  group_by(member_casual, daynum) %>% 
  summarize(x = sum(trip_delta_x), 
            y = sum(trip_delta_y),
            mean_x = mean(trip_delta_x),
            mean_y = mean(trip_delta_y),
            magnitude = sqrt(x^2 + y^2),
            angle = angle_from_x_axis(y,x)) %>% 
  ggplot(aes(x=0, y=0, xend=x, yend=y, color=member_casual)) +
  geom_hline(yintercept = 0, color = 'gray80') +
  geom_vline(xintercept = 0, color = 'gray80') +
  theme_gray() +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_blank()) +
  geom_segment(arrow = arrow(length = unit(0.1, "npc"))) +
  facet_wrap(~daynum) +
  labs(title = "Overall traffic direction and strength in May, by day")
```

There is a huge signal on May 30, 2020 and near-zero activity the following day.

```{r}
df %>% 
  mutate(hour = lubridate::hour(started_at)) %>% 
  filter(lubridate::month(started_at) == 5,
         lubridate::day(started_at) == 30,
         lubridate::year(started_at) == 2020) %>% 
  group_by(member_casual, hour) %>% 
  summarize(x = sum(trip_delta_x), 
            y = sum(trip_delta_y),
            mean_x = mean(trip_delta_x),
            mean_y = mean(trip_delta_y),
            magnitude = sqrt(x^2 + y^2),
            angle = angle_from_x_axis(y,x)) %>% 
  ggplot(aes(x=0, y=0, xend=x, yend=y, color=member_casual)) +
  geom_hline(yintercept = 0, color = 'gray80') +
  geom_vline(xintercept = 0, color = 'gray80') +
  theme_gray() +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_blank()) +
  geom_segment(arrow = arrow(length = unit(0.1, "npc"))) +
  facet_wrap(~hour) +
  labs(title = "Overall traffic direction and strength on May 30, 2020, by hour")
```

Most of the activity starts after 3pm. Searching the internet, we find that 
May 30 2020 was the date
of a massive *Black Lives Matter* protest in Chicago. It appears that many people used
the bikes to get to and from the protests.  The following day under guidance
from the city, Divvy shut down the bike share service at 4pm.

[Reference:](https://chicago.cbslocal.com/2020/05/31/divvy-bikes-to-close-system-at-4-p-m-amid-unrest-in-chicago/)

## Traffic Flow: Hourly and daily patterns
Here we calculate the overall traffic flow in the bike system. Each arrow
represents the sum, or overall effect, of all trips taken during a one-hour period.  
We'll use this to examine the difference in overall traffic flow over each hour 
in a week, comparing members vs casual users.

```{r create motion vectors day-of-week-hour, echo=FALSE}
# day-of-the-week plus hour trends
dow_hour_vec <- df %>% 
  group_by(member_casual,
           weekday,
           hour = as_factor(lubridate::hour(started_at))) %>% 
  summarize(x = sum(trip_delta_x), 
            y = sum(trip_delta_y),
            mean_x = mean(trip_delta_x),
            mean_y = mean(trip_delta_y),
            magnitude = sqrt(x^2 + y^2),
            angle = angle_from_x_axis(y,x))

ggplot(dow_hour_vec, aes(x=0, y=0, xend=x, yend=y, color=hour)) +
  geom_hline(yintercept = 0, color = 'gray80') +
  geom_vline(xintercept = 0, color = 'gray80') +
  theme_gray() +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_blank()) +
  geom_segment(arrow = arrow(length = unit(0.02, "npc")),  size=.8) +
  facet_wrap(~member_casual) +
  labs(title = "Overall traffic direction and strength",
       subtitle = "Each arrow is one hour on a particular day") +
  scale_color_viridis(discrete = TRUE, option="turbo")
```

Let's look at the members first. The blue-green arrows pointing southeast
show a strong trend in the morning hours for members to ride in that
direction. Recalling the early-morning spike in member traffic, these
arrows represent the morning rush hour.  The orange-red arrows pointing
northwest represent the evening commute.  The pattern for members is
very strong: the overall traffic flow is dominated by commuters.

For casual users the signal is weaker, showing that casual riders tend
to ride to more varied destinations.  Still, there is a clear distinction
shown by the colours: morning traffic trends east and afternoon & evening
traffic trends west.

Let's break this down further and split the trips into weekends vs weekdays.

```{r create motion vectors weekday-hour, echo=FALSE, fig.asp=.7, fig.height=8}
# day-of-the-week plus hour and weekend flag
wewd_hour_vec <- df %>% 
  group_by(member_casual,
           weekend_weekday,
           weekday,
           hour = as_factor(lubridate::hour(started_at))) %>% 
  summarize(x = sum(trip_delta_x), 
            y = sum(trip_delta_y),
            mean_x = mean(trip_delta_x),
            mean_y = mean(trip_delta_y),
            magnitude = sqrt(x^2 + y^2),
            angle = angle_from_x_axis(y,x))

ggplot(wewd_hour_vec, aes(x=0, y=0, xend=x, yend=y, color=hour)) +
  geom_hline(yintercept = 0, color = 'gray80') +
  geom_vline(xintercept = 0, color = 'gray80') +
  theme_gray() +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_blank()) +
  geom_segment(arrow = arrow(length = unit(0.02, "npc"))) +
  facet_grid(cols = vars(member_casual),
             rows = vars(weekend_weekday)) +
  labs(title = "Overall traffic direction and strength",
       subtitle = "Each arrow is one hour on a particular day") +
  scale_color_viridis(discrete = TRUE, option="turbo")
```

Things become clearer. During the week, casual traffic follows the same pattern
as members, suggesting that many of these trips are actually for commuting.

Next, let's examine casual traffic flow only.

```{r create motion vectors casual weekend-weekday}
# hourly trends for weekday vs weekend
weekend_hour_vecs <- df %>% 
  group_by(member_casual,
           weekend_weekday,
           hour = as_factor(lubridate::hour(started_at))) %>% 
  summarize(x = sum(trip_delta_x), 
            y = sum(trip_delta_y),
            mean_x = mean(trip_delta_x),
            mean_y = mean(trip_delta_y),
            magnitude = sqrt(x^2 + y^2),
            angle = angle_from_x_axis(y,x)) 

weekend_hour_vecs %>% 
  filter(member_casual == 'casual') %>% 
  ggplot(aes(x=0, y=0, xend=x, yend=y, color=hour)) +
  geom_hline(yintercept = 0, color = 'gray80') +
  geom_vline(xintercept = 0, color = 'gray80') +
  theme_gray() +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_blank()) +
  geom_segment(arrow = arrow(length = unit(0.02, "npc")), size=1) +
  facet_wrap(~weekend_weekday) +
  labs(title = "Casual traffic flow: weekday vs weekend",
       subtitle = "Each arrow is one hour of traffic") +
  scale_color_viridis(discrete = TRUE, option="turbo")
```

We see the commuting pattern during the weekdays, traveling mostly along
the northwest-southeast diagonal. 
On the weekend however, things are more interesting. Many casual trips are taken 
in the morning to early afternoon, traveling
northeast.  In the afternoon the traffic flow swings to
the west. Recalling our map of casual hot spots earlier, we suggest that a
majority of casual users are taking trips to the waterfront, spending some time there,
and then returning home.

As one last view, let's examine these patterns over a typical week.

```{r Traffic flow by hour and weekday faceted 2}
ggplot(dow_hour_vec, aes(x=0, y=0, xend=x, yend=y, color=hour)) +
  geom_hline(yintercept = 0, color = 'gray80') +
  geom_vline(xintercept = 0, color = 'gray80') +
  theme_gray() +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_blank()) +
  geom_segment(arrow = arrow(length = unit(0.02, "npc")), size=0.9) +
  facet_grid(rows = vars(member_casual),
             cols = vars(weekday)) +
  labs(title = "Traffic flow over the week: member vs casual") +
  scale_color_viridis(discrete = TRUE, option="turbo")
```




## TODO

- Bike Motion maps: calculate total "bike miles" moved in a certain direction
  to make the abstract arrows more concrete.
    - **A  grid of arrows like a direction field**: aggregate into rectangles like before, calculate
    the averate motion per rect and create an arrow, and map all the arrows
    at the center of the squares!
      - This could be animated by the hour.... giving **a traffic flow like
      a bed of seagrass flowing in the tide...**
- visualize timelapse behaviour
  - trips starting from a sector, with scrubbable hour (tableau!)
    - or as an animation
  - and similarly, ending at a sector..
- Can you draw a map of LINES connecting start and end points for
    trips..?
  - or similarly, for e.g. 4-4:59pm, a cloud of dots in two colours,
      trips started and trips ended, at every location.
- What were the busiest casual days? Holidays? Sports events?
  - Where was the traffic starting and ending?

















