---
title: "Analyze: How do Casual Users and Annual Subscribers Differ?"
author: "Andrew Luyt"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load data, include=FALSE}
library(tidyverse)
library(lubridate)
library(data.table)
library(sf)
library(here)
library(viridis)

DATA = here("data/alldata.csv")

df <- fread(
  DATA,
  colClasses = c(start_station_id = 'character',
                 end_station_id = 'character'),
  stringsAsFactors = TRUE,
  showProgress = FALSE
)

# put the factors in convenient order now, else we'll have to do this
# every time we make a plot using the weekday.
df <- df %>%
  mutate(weekday = fct_relevel(
    weekday,
    c(
      "Monday",
      "Tuesday",
      "Wednesday",
      "Thursday",
      "Friday",
      "Saturday",
      "Sunday"
    )
  ))

```

## Who rides most often?
Members take the majority of rides.
```{r who rides most often, echo=FALSE}
df %>% ggplot(aes(x = member_casual, fill = member_casual)) +
  geom_bar()
```


## How do they differ on type of bike ridden?
Casuals are more likely to choose a docked bike and less likely to choose a
classic bike.

**This is confusing**.  The divvy website lists two types of bikes, **classic**
and **electric bike.** What is a **docked bike**?
```{r differ on bike type, echo=FALSE}
# df %>%
#   group_by(member_casual, rideable_type) %>%
#   summarise(n = n(), .groups = "drop_last") %>%
#   mutate(percentage = n / sum(n) * 100)

df %>%
  ggplot(aes(member_casual, fill = rideable_type)) +
  geom_bar(position = "fill")

```

# How long do they ride?
Casuals ride more than twice as long as members, on average.
```{r mean ride length, echo=FALSE}
#knitr::kable(
df %>% 
  group_by(member_casual) %>% 
  summarise(mean_ride_length = mean(trip_minutes)) %>% 
  ggplot(aes(member_casual, mean_ride_length, fill = member_casual)) +
  geom_col() +
  labs(title = "Average ride length: casuals vs members")
```

## Members ride more often, casuals ride longer: who rides the most minutes?
Casuals spend more time using the bicycles.
```{r echo=FALSE}
df %>% group_by(member_casual) %>% 
  summarise(total_minutes = sum(trip_minutes)) %>% 
  ggplot(aes(member_casual, total_minutes, fill= member_casual)) +
  geom_col()
```



## What is the distribution of ride lengths?

A quick examination shows a few notable items:

- Casuals have a higher mean and median trip time. i.e. they tend to take
longer trips
- The difference is amplified in the particularly long trips
  - compare the 95th percentile trip time. 5% of casuals take trips longer
  than 1:50!
```{r trip length details, echo=FALSE, message=FALSE}
df %>% 
  group_by(member_casual) %>% 
  select(trip_minutes) %>% 
  summarise(mean = mean(trip_minutes),
            median = median(trip_minutes),
            quantiles = quantile(trip_minutes, c(0.25, 0.75, 0.95)),
            q = c(0.25, 0.75, 0.95))
```

From above we see there is a **wide** range of trip lengths, with most being
short and a small number being over an hour. We will trim off the longest 5% of
trips so we can see the typical pattern of ride length.

**One observation is that casual riders make up almost all trips longer than 40 
minutes!**

**TODO: is there some limitation on ride length for members? The cutoff
around 40 minutes looks quite sudden.**

One question to arise from this: what sort of bike is most comfortable for
long trips, and which are better for short ones?  Do members tend to choose
lighter, speedier bikes and do casuals prefer bikes with more comfort?
```{r trip length histogram}
df %>% 
  group_by(member_casual) %>%  # IMPORTANT! Trim the top 5% of EACH GROUP, separately
  filter(trip_minutes < quantile(trip_minutes, 0.95)) %>% 
  ungroup() %>% 
  ggplot(aes(x = trip_minutes, fill = member_casual, color = member_casual)) +
  geom_histogram(bins = 40, alpha = 0.7)
```

## Ride length, by weekday

We see an unsurprising distribution of trip times over the week: a slight 
increase over the weekend, with casual riders having showing a larger
difference.
```{r tuesday oddity}
df %>% 
  group_by(weekday, member_casual) %>% 
  summarise(mean_ride_length = mean(trip_minutes)) %>% 
  ggplot(aes(weekday, mean_ride_length, fill=member_casual)) +
  geom_col(position = position_dodge(width = 0.4), alpha = 0.8)
```

## Number of trips by day of the week
We see here that:

- Member use is fairly steady through the week
- Casual use increases on Friday and nearly doubles through the weekend.

We can take this as more evidence that members are often commuting,
whereas casuals are primarily riding for other reasons (enjoyment, exercise?)
```{r day of week, echo=FALSE}
df %>%
  ggplot(aes(weekday, fill = member_casual)) +
    geom_bar(position = position_dodge(width = 0.5), alpha = 0.8)
  #facet_wrap(~member_casual) +)
```

## Trips volume trend over the last year

- There is an enormous seasonal variation, from a low of 15 rides to a high of
almost 20,000 in one day.
- The trend in 2021 is for higher volume than 2020
- Casual membership seems to be rising more sharply in 2021
```{r daily trips, message=FALSE}
df %>% 
  group_by(date(started_at), member_casual) %>% 
  summarise(n_rides = n()) %>% 
  rename(date = 1) %>% 
  ggplot(aes(x = date, y = n_rides, color = member_casual)) +
  geom_point() +
  geom_smooth() + 
  labs(title = "Daily trip volume, 2020-2021", x = 'Date', y = "Rides")
```

## Do weekends matter?
Yes, but only for casuals and not in winter.

```{r do weekends matter, message=FALSE}
df %>% 
  mutate(is_weekend = as_factor(weekday %in% c('Saturday', 'Sunday'))) %>% 
  group_by(date(started_at), member_casual, is_weekend) %>% 
  summarise(n_rides = n()) %>% 
  rename(date = 1) %>% 
  ggplot(aes(x = date, y = n_rides, color = is_weekend)) +
  geom_point(alpha=0.5) +
  geom_smooth(se = FALSE, size = 2) + 
  facet_wrap(~member_casual) +
  labs(title = "Do Weekends Matter?", subtitle = "Daily trip volume, 2020-2021", x = 'Date', y = "Rides")
```


## Do they differ in *what hour* rides are taken?
There seems to be a slight tendency for casuals to start their rides later.
The tendency is similar for ending times (not shown.)

```{r hour of trip start, echo=FALSE}
df %>% 
  ggplot(aes(x=member_casual, y=hour(started_at), fill = member_casual)) +
  geom_boxplot() +
  labs(x="", y = "hour of trip start")
```


## Hour of trip start, in detail
Lending more weight to the 'members commute more often' hypothesis we see
two jumps in member activity, both starting around morning and evening
commute times.  Casual users have a much smoother increase in trips
as the day goes on. Two possible interpretations are that 
casuals are using a bike for their commute less often,
or casual users tend to have non-typical start times for their job.
```{r hour of trip start detailed, echo=FALSE}
df %>% ggplot(aes(hour(started_at), fill=member_casual)) +
  geom_bar(position = position_dodge(width=0.7), alpha = 0.8)
```


## Are some stations preferred by casuals?
Dramatically so! Some stations are 100% casual use and others are near-zero!
The median station is 42% casual use.

```{r station use, echo=FALSE}
df %>% 
  group_by(start_station_id, member_casual) %>% 
  summarise(n = n(), .groups = 'drop_last') %>% 
  mutate(percentage = n / sum(n) * 100) %>% 
  filter(member_casual == "casual") %>% 
  ggplot(aes(percentage)) + 
  geom_histogram(bins = 30, fill='deepskyblue') +
  labs(title="Distribution of station use",
       subtitle = "Stations vary from 100% casual to near-zero!",
       x = 'Percentage of casuals',
       y = 'Number of stations')
```

## Break stations into 10 groups: slowest to busiest
### TODO: check this entire section, seems iffy
On the left, the slowest 10% of stations (by number of trips started there)
are preferred by members. This is important as these unpopular stations are
used most often by our members whom we desire to keep.

```{r station popularity quantiles, echo=FALSE, message=FALSE}
tmp <- df %>% 
  group_by(start_station_id, member_casual) %>% 
  summarise(trips_by_type = n()) %>% 
  ungroup() %>% 
  group_by(start_station_id) %>%
  summarise(n_trips = sum(trips_by_type),
            trips_by_type = identity(trips_by_type),
            member_casual = identity(member_casual),
            proportion = trips_by_type / n_trips) %>% 
  ungroup() %>% 
  mutate(decile_popularity = cut(x = n_trips,
                      breaks = quantile(n_trips, probs = seq(0.05,.95,0.1)),
                      # labels = c(.1,2,.3,.4,.5,.6,.7,.8,.9,1)
                      )) 

tmp %>% 
  group_by(decile_popularity, member_casual) %>% 
  summarise(n = n()) %>% 
  ggplot(aes(decile_popularity, n, fill=member_casual)) +
  geom_col(position='fill') +
  labs(x = '',
       y = 'Proportion using these stations')

# unique(tmp$decile)
```

## Order all stations by popularity, plot the proportion of members using it

We see a clear pattern. As staions get busier, the proportion of casuals rises.
There is still a large amount of variability however.
```{r station popularity scatter and fit, echo=FALSE, message=FALSE}
df %>% 
  group_by(start_station_id, member_casual) %>% 
  summarize(n = n()) %>% 
  mutate(total = sum(n)) %>% 
  filter(member_casual == 'casual') %>% 
  mutate(casual_percent = n / total * 100,
         mostly_casual = casual_percent > 50) %>% 
  arrange(desc(total)) %>% 
  ggplot(aes(desc(rank(total)), casual_percent)) +
  geom_point(aes(color = mostly_casual)) +
  geom_smooth() +
  scale_x_continuous(breaks = NULL, name = "(-)     Station Popularity     (+)") +
  labs(x = 'Popularity of station', y = '% who are casuals',
       title = 'Percent of riders being casuals, by station popularity',
       subtitle = "The busier a station, the more often that casuals tend to use them")
```


## Plot stations on the map
ideas:

- Size of dot varies with station popularity
- the colour varies with the proportion of users (by trip start) who are casuals. 
  - First step: mostly_casual to colour the stations with binary scheme

```{r echo=FALSE, message=FALSE}
# boundaries_chi = st_read(here("data/Chicago_Boundaries-ZIP_Codes.geojson"),
#                          quiet = TRUE)
boundaries_chi = st_read(here("data/Chicago_Boundaries-Neighborhoods.geojson"),
                         quiet = TRUE)
boundaries_chi <- boundaries_chi %>%
  select(geometry)

  
x2 <- df %>% 
  # slice_sample(n = 1000000) %>% 
  group_by(start_lng_sector, start_lat_sector, member_casual) %>% 
  summarise(avg_trip_mins = mean(trip_minutes), n_trips_sector = n()) %>% 
  filter(n_trips_sector > 4)  # remove some weird outliers

# use the summary you just calculated
# for a heatmap use bin2d and the identity stat -----------------------------
ggplot(boundaries_chi, aes()) + 
  geom_sf() +
  geom_bin2d(data = x2, stat = 'identity',
             mapping = aes(start_lng_sector, start_lat_sector, fill= avg_trip_mins),
             alpha = 1) +
  scale_fill_viridis(option = 'plasma') +
  facet_wrap(~member_casual) +
  labs(title = "Length of trips starting here")

x3 <- df %>% 
  # slice_sample(n = 1000000) %>% 
  group_by(end_lng_sector, end_lat_sector, member_casual) %>% 
  summarise(avg_trip_mins = mean(trip_minutes), n_trips_sector = n()) %>% 
  filter(n_trips_sector > 4)  # remove some weird outliers

# heatmap: use bin2d and the identity stat -----------------------------
ggplot(boundaries_chi, aes()) + 
  geom_sf() +
  geom_bin2d(data = x3, stat = 'identity',
             mapping = aes(end_lng_sector, end_lat_sector, fill= avg_trip_mins),
             alpha = 1) +
  scale_fill_viridis(option = 'plasma') +
  facet_wrap(~member_casual) +
  labs(title = "Length of trips ending here")


# let the geom (hexbin, 2d density, count) do the aggregation from raw lng/lat
boundaries_chi %>% ggplot(aes()) + 
  geom_sf() +
  geom_bin2d(data = df, mapping = aes(start_lng, start_lat)) +
  scale_fill_viridis(option = 'plasma') +
  facet_wrap(~member_casual) +
  theme(panel.background = element_rect(fill = "white")) +
  labs(title="Number of trips started in this area")

# TRIP ENDS
ggplot(boundaries_chi, aes()) + 
    geom_sf() +
    geom_bin2d(data = df,
            mapping = aes(end_lng, end_lat)) +
  scale_fill_viridis(option = 'plasma') +
  facet_wrap(~member_casual) +
  theme(panel.background = element_rect(fill = "white")) +
  labs(title="Number of trips ended in this area")

# TRIP starts and ends in the same station
# see how there is a huge spike of round tripping casuals right in that one area
pleasure_cruises <- df %>% 
  filter(is_round_trip == 'round trip')
ggplot(boundaries_chi, aes()) + 
  geom_sf() +
  # geom_hex(data = pleasure_cruises,
  #           mapping = aes(end_lng, end_lat)) +
  geom_bin2d(data = pleasure_cruises,
             mapping = aes(end_lng, end_lat)) +
  scale_fill_viridis(option = 'plasma') +
  facet_wrap(~member_casual) +
  theme(panel.background = element_rect(fill = "white")) +
  labs(title="Number of trips started & ended at the same station")
rm(pleasure_cruises)

# TRIP starts and ends in different places: map start point
a_to_b <- df %>% 
  filter(is_round_trip == 'a to b')
ggplot(boundaries_chi, aes()) + 
  geom_sf() +
  # geom_hex(data = a_to_b,
  #          mapping = aes(start_lng, start_lat)) +
  geom_bin2d(data = a_to_b,
           mapping = aes(start_lng, start_lat)) +
  scale_fill_viridis(option = 'plasma') +
  facet_wrap(~member_casual) +
  theme(panel.background = element_rect(fill = "white")) +
  labs(title="Number of trips started here and ending elsewhere")
# TRIP starts and ends in different places: map END point
ggplot(boundaries_chi, aes()) + 
  geom_sf() +
  # geom_hex(data = a_to_b,
  #          mapping = aes(end_lng, end_lat)) +
  geom_bin2d(data = a_to_b,
           mapping = aes(end_lng, end_lat)) +
  scale_fill_viridis(option = 'plasma') +
  facet_wrap(~member_casual) +
  theme(panel.background = element_rect(fill = "white")) +
  labs(title="Number of trips started elsewhere & ended here")
rm(a_to_b)

# Facet on membership & is_round_trip
# 42 & 25 are the number of rectangular sectors
ggplot(boundaries_chi, aes()) + 
  # geom_sf() +
  geom_bin2d(data = df,
             mapping = aes(start_lng, start_lat)) +
  scale_fill_viridis(option = 'plasma') +
  facet_wrap(~member_casual + is_round_trip, scales = 'free', ) +
  theme(panel.background = element_rect(fill = "white"), aspect.ratio = 42/25) +
  labs(title="Number of trips that started here")
ggplot(boundaries_chi, aes()) + 
  # geom_sf() +
  geom_bin2d(data = df,
             mapping = aes(end_lng, end_lat)) +
  scale_fill_viridis(option = 'plasma') +
  facet_wrap(~member_casual + is_round_trip, scales = 'free', ) +
  theme(panel.background = element_rect(fill = "white"), aspect.ratio = 42/25) +
  labs(title="Number of trips that ended here")

# make a station density map
stations <- df %>% 
  group_by(start_station_id, member_casual) %>% 
  summarise(station_lng = mean(start_lng), 
            station_lat = mean(start_lat),
            n_trips = n(),
            mean_duration = mean(trip_minutes),
            log_mean_duration  = log2(mean_duration)) %>% 
  filter(n_trips > 10)  # remove stations w/o enough data
stations_sectored <- df %>% 
  group_by(start_lng_sector, start_lat_sector, member_casual) %>% 
  summarise(n_trips = n(),
            mean_duration = mean(trip_minutes),
            log_mean_duration = log2(mean_duration)) %>% 
  filter(n_trips > 10)
stations_sectored_end <- df %>% 
  group_by(end_lng_sector, end_lat_sector, member_casual) %>% 
  summarise(n_trips = n(),
            mean_duration = mean(trip_minutes),
            log_mean_duration = log2(mean_duration)) %>% 
  filter(n_trips > 10)

ggplot(boundaries_chi, aes()) +
  geom_sf() +
  geom_bin2d(data = stations,
             mapping = aes(station_lng, station_lat)) +
  scale_fill_viridis(option= 'plasma') +
  labs(title = 'Station density')

# trip durations map -------------
# individual stations - 'scatterplot'
ggplot(boundaries_chi, aes()) +
  geom_sf() +
  geom_point(data = stations,
             mapping = aes(station_lng, station_lat, color = mean_duration)) +
  scale_color_viridis(option= 'plasma') +
  labs(title = 'Mean duration of trips started here')
# stations binned into sectors
ggplot(boundaries_chi, aes()) +
  geom_sf() +
  geom_bin2d(data = stations_sectored, stat = 'identity',
             mapping = aes(start_lng_sector, start_lat_sector, fill = mean_duration)) +
  scale_fill_viridis(option= 'plasma') +
  labs(title = 'Mean duration of trips started here')
# stations binned into sectors & mean_duration log-transformed
ggplot(boundaries_chi, aes()) +
  geom_sf() +
  geom_bin2d(data = stations_sectored, stat = 'identity',
             mapping = aes(start_lng_sector, start_lat_sector, fill = log_mean_duration)) +
  scale_fill_viridis(option= 'plasma') +
  labs(title = 'Mean duration of trips started here (log-transformed duration)')
# stations binned into sectors & mean_duration log-transformed - by ENDING station
ggplot(boundaries_chi, aes()) +
  geom_sf() +
  geom_bin2d(data = stations_sectored_end, stat = 'identity',
             mapping = aes(end_lng_sector, 
                           end_lat_sector, 
                           fill = log_mean_duration)) +
  scale_fill_viridis(option= 'plasma') +
  labs(title = 'Mean duration of trips ended here (log-transformed duration)')

```

## Average rider motion by hour
Here we'll examine the overall traffic flow: as the hours go by, do riders tend
to ride in a particular direction?  (yes)  We expected this because the
morning and evening commute times are not of equal magnitude.  Overall it
seems like there is a daily tendency for riders (and bicycles) to move
northwest.

### TODO: make interpretable with distance
This has connections with how Divvy may have to shuttle bikes around at night
to ensure the busy stations have bikes

- the average rider (and bike!) moves Xm west by northwest
- overall, traffic moves Xm west by northwest

```{r create motion vectors}
angle_from_x_axis <- function(y,x) {
  angle <- atan(y/x)
  if (x<0) {
    angle <- angle + pi
  } else if (x>=0 & y<0) {
    angle <- angle + 2*pi
  } 
  angle * 180 / pi
}
overall_vec <- df %>% 
  summarize(x = sum(trip_delta_x), 
            y = sum(trip_delta_y),
            mean_x = mean(trip_delta_x),
            mean_y = mean(trip_delta_y),
            magnitude = sqrt(x^2 + y^2),
            angle = angle_from_x_axis(y,x),
            atan = atan(y/x))
monthly_vec <- df %>% 
  group_by(month = month(started_at),
           hour = lubridate::hour(started_at)) %>% 
  summarize(x = sum(trip_delta_x), 
            y = sum(trip_delta_y),
            mean_x = mean(trip_delta_x),
            mean_y = mean(trip_delta_y),
            magnitude = sqrt(x^2 + y^2),
            angle = angle_from_x_axis(y,x),
            atan = atan(y/x))
dow_vec <- df %>% 
  group_by(weekday,
           hour = lubridate::hour(started_at)) %>% 
  summarize(x = sum(trip_delta_x), 
            y = sum(trip_delta_y),
            mean_x = mean(trip_delta_x),
            mean_y = mean(trip_delta_y),
            magnitude = sqrt(x^2 + y^2),
            angle = angle_from_x_axis(y,x),
            atan = atan(y/x))
vecs <- df %>% 
  group_by(hour = lubridate::hour(started_at)) %>% 
  summarize(x = sum(trip_delta_x), 
            y = sum(trip_delta_y),
            mean_x = mean(trip_delta_x),
            mean_y = mean(trip_delta_y),
            magnitude = sqrt(x^2 + y^2),
            angle = angle_from_x_axis(y,x)) 
```

## Overall traffic flow by hour
We compute an estimate of the overall flow of traffic (direction and distance) 
for every trip taken each hour.  (*Technical note: This is done by adding the
vectors of every trip up to compute the 'overall trip' during that hour)

```{r traffic flow by hour}
ggplot(vecs, aes(x=0, y=0, xend=x, yend=y)) +
  geom_hline(yintercept = 0, color = 'gray80') +
  geom_vline(xintercept = 0, color = 'gray80') +
  facet_wrap(~hour) +
  theme_gray() +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_blank()) +
  geom_segment(arrow = arrow(length = unit(0.1, "npc")), color='blue') +
  labs(title = "Overall traffic direction and strength, by hour")
```

## Traffic flow by hour and weekday

```{r Traffic flow by hour and weekday}
ggplot(dow_vec, aes(x=0, y=0, xend=x, yend=y, color=as_factor(weekday))) +
  geom_hline(yintercept = 0, color = 'gray80') +
  geom_vline(xintercept = 0, color = 'gray80') +
  theme_gray() +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_blank()) +
  geom_segment(arrow = arrow(length = unit(0.1, "npc"))) +
  facet_wrap(~hour) +
  labs(title = "Overall traffic direction and strength, by hour",
       subtitle = "Colours denote weekday",
       caption = "Note the variation on different days between 4-6pm")
```

## Examining the evening rush hour traffic
The rush hour traffic flow has two main patterns.

- On **Monday to Thursday** rush hour traffic trends strongly to the northwest.
- On **weekends** the rush hour traffic trends west to southwest

```{r Traffic flow by hour and weekday limited to rush hour}
dow_vec %>%
  filter(between(hour, 16, 18)) %>%
  ggplot(aes(
    x = 0,
    y = 0,
    xend = x,
    yend = y,
    color = as_factor(weekday)
  )) +
  geom_hline(yintercept = 0, color = 'gray80') +
  geom_vline(xintercept = 0, color = 'gray80') +
  theme_gray() +
  theme(
    axis.text = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    panel.background = element_blank()
  ) +
  geom_segment(arrow = arrow(length = unit(0.1, "npc"))) +
  facet_wrap( ~ hour) +
  labs(title = "Rush hour traffic direction and strength",
       subtitle = "Evening rush hour: 4 - 6pm",
       caption = "Weekends have their own distinct pattern")
```

## Hourly traffic flow, with monthly patterns

```{r traffic flow by hour and month}
ggplot(monthly_vec, aes(x=0, y=0, xend=x, yend=y, color=as_factor(month))) +
  geom_hline(yintercept = 0, color = 'gray80') +
  geom_vline(xintercept = 0, color = 'gray80') +
  theme_gray() +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_blank()) +
  geom_segment(arrow = arrow(length = unit(0.1, "npc"))) +
  facet_wrap(~hour) +
  labs(title = "Overall traffic direction and strength, by hour",
       subtitle = "Colours denote months",
       caption = "Little variation by month: the main effect is the hour")
```


## TODO

- ADD FEATURE: Calculate mean straight-line **distance** of trips started and ended in each
sector.
  - is it better to do straight line, or horizontal + vert distances
    ("manhattan distance") and add them?
- visualize timelapse behaviour
  - trips starting from a sector, with scrubbable hour (tableau!)
    - or as an animation
  - and similarly, ending at a sector..
  - Can you draw a map of LINES connecting start and end points for
    trips..?
    - or similarly, for e.g. 4-4:59pm, a cloud of dots in two colours,
      trips started and trips ended, at every location.
- a map of all stations, coloured by the proportion of casual users who
  start/end trips at this station.
  - size the dots based on the popularity of the station (# of trips
  starting/ending there)
- find the fastest rides:
  - use trip time and straight-line distance
- is there a 'mean travel direction'?
  - like, morning tends to go north, 5pm it switches?
  - calculate by the hour and draw an arrow with direction and strength?
    - seems like vectors would work... and we have all the components!
      - start_lng, start_lat, end_lng, end_lat
      - this is a vector with angle arctan(delta_y/delta_x) (Quadrant!) and
        magnitude sqrt(delta_x^2 + delta_y^2)
      - BETTER: just add up all the delta_x and delta_y componenets of every
      trip in that hour and you end up with a vector pointing to the
      overall (sum of) trip direction and distance.














