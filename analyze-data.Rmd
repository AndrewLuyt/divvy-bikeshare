---
title: "Analyze: How do Casual Users and Annual Subscribers Differ?"
author: "Andrew Luyt"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load data, include=FALSE}
library(tidyverse)
library(lubridate)
library(data.table)
library(sf)
library(here)
library(viridis)

x.txt.size = 15  # scale the x axis ticks in many graphs

DATA = here("data/alldata.csv.gz")
df <- fread(
  DATA,
  colClasses = c(start_station_id = 'character',
                 end_station_id = 'character'),
  stringsAsFactors = TRUE,
  showProgress = FALSE
)

# put the factors in convenient order now, else we'll have to do this
# every time we make a plot using the weekday.
df <- df %>%
  mutate(weekday = fct_relevel(
    weekday,
    c(
      "Monday",
      "Tuesday",
      "Wednesday",
      "Thursday",
      "Friday",
      "Saturday",
      "Sunday"
    )
  ))

# Chicago neighbourhood boundaries as Simple Features. We only need
# the geometry for mapping, all the attributes can be discarded.
boundaries_chi = st_read(here("data/Chicago_Boundaries-Neighborhoods.geojson"),
                         quiet = TRUE)
boundaries_chi <- boundaries_chi %>%
  select(geometry)
```

## Who rides most often?
Members take the majority of rides.

```{r who rides most often, echo=FALSE}
df %>% ggplot(aes(x = member_casual, fill = member_casual)) +
  geom_bar() +
  scale_y_continuous(labels = scales::comma) +
  labs(
    title = "Total number of rides",
    subtitle = paste("Since", lubridate::month(min(df$started_at), label = TRUE),
                     year(min(df$started_at))),
    x = NULL,
    y = "Rides"
  ) +
  theme(axis.text.x = element_text(size = x.txt.size))
```


## How do they differ on type of bike ridden?
Casuals are more likely to choose a docked bike and less likely to choose a
classic bike.

**This is confusing**.  The divvy website lists two types of bikes, **classic**
and **electric bike.** What is a **docked bike**?

```{r differ on bike type, echo=FALSE}
# df %>%
#   group_by(member_casual, rideable_type) %>%
#   summarise(n = n(), .groups = "drop_last") %>%
#   mutate(percentage = n / sum(n) * 100)

df %>%
  ggplot(aes(y = member_casual, fill = rideable_type)) +
  geom_bar(position = "fill") +
  scale_x_continuous(labels = scales::comma) +
  labs(title="What kind of bikes are being chosen?", subtitle="Casuals vs Members",
       y=NULL, x = 'Proportion')
```

## How do trip distances vary?
This is a bit surprising - the average trip is about the same distance for
both classes of users.  For this analysis we've removed trips that start and end 
at the same station since we have no indication how long the trip was.

```{r}
df %>% 
  filter(is_round_trip == 'a to b') %>% 
  group_by(member_casual) %>% 
  summarise(mean_trip_distance = mean(trip_distance_m)) %>% 
  ggplot(aes(member_casual, mean_trip_distance, fill = member_casual)) +
  geom_col() +
  labs(title = "Average trip distance (Km)",
       subtitle = "Casuals vs Members",
       caption  = 'Distance is straight-line, or "as the crow flies."',
       x = NULL, y = "Kilometers") +
  geom_text(aes(label = round(mean_trip_distance / 1000, digits = 1)), 
            vjust = 2.1,
            size = 6) +
  theme(legend.position = "none",
        axis.text.x = element_text(size = x.txt.size))
```


## How much time is spent on an average ride?
Casuals ride more than twice as long as members, on average.

```{r mean ride length, echo=FALSE}
#knitr::kable(
df %>% 
  group_by(member_casual) %>% 
  summarise(mean_ride_length = mean(trip_minutes)) %>% 
  ggplot(aes(member_casual, mean_ride_length, fill = member_casual)) +
  geom_col() +
  labs(title = "Average ride length (minutes)", 
       subtitle = "Casuals vs Members",
       x = NULL, y = "Minutes") +
  geom_text(aes(label = round(mean_ride_length, digits = 1)), 
            vjust = 2.1,
            size = 6) +
  theme(legend.position = "none",
        axis.text.x = element_text(size = x.txt.size))
```

## Ride speed
We've seen that casuals and members ride about the same distances, but members
spend less time on the bikes. The graph below shows that members are about
30% faster on average.

We've removed trips that start and end at the same station, since their recorded
trip distance is 0.

```{r}
df %>% 
  filter(is_round_trip == 'a to b') %>%
  mutate(kph = (trip_distance_m / 1000) / (trip_minutes / 60)) %>% 
  group_by(member_casual) %>% 
  summarise(mean_kph = mean(kph)) %>% 
  ggplot(aes(member_casual, mean_kph, fill = member_casual)) +
  geom_col() +
  labs(title = "Mean trip speed (Kph)",
       subtitle = "Members ride about 30% faster",
       x = NULL, y = "Kilometers per hour") +
  geom_text(aes(label = round(mean_kph, digits = 1)), 
            vjust = 2.1,
            size = 6) +
  theme(legend.position = "none",
        axis.text.x = element_text(size = x.txt.size))
```


## Members ride more often, casuals ride longer: who rides the most total minutes?
Casuals spend more time using the bicycles.

```{r echo=FALSE}
df %>% group_by(member_casual) %>% 
  summarise(total_minutes = sum(trip_minutes)) %>% 
  ggplot(aes(member_casual, total_minutes, fill= member_casual)) +
  geom_col() +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Who is in the saddle the longest?",
       subtitle=paste("Total minutes since", 
                      lubridate::month(min(df$started_at), label = TRUE),
                      year(min(df$started_at))),
       x = NULL,
       y = "Total Minutes") +
  stat_summary(fun.y = sum, 
               geom="text", 
               aes(label=scales::comma(total_minutes)), vjust = 2, size=5) +
  theme(legend.position = "none", 
        axis.text.x = element_text(size=x.txt.size))
```


## What is the distribution of ride durations?

A quick examination shows a few notable items:

- Casuals have a higher mean and median trip time. i.e. they tend to take
longer trips
- The difference is amplified in the particularly long trips
  - compare the 95th percentile trip time. 5% of casuals take trips longer
  than 1:50!
  
```{r trip length details, echo=FALSE, message=FALSE}
df %>% 
  group_by(member_casual) %>% 
  select(trip_minutes) %>% 
  summarise(mean = mean(trip_minutes),
            median = median(trip_minutes),
            quantiles = quantile(trip_minutes, c(0.25, 0.75, 0.95)),
            q = c(0.25, 0.75, 0.95))
```

From above we see there is a **wide** range of trip lengths, with most being
short and a small number being over an hour. We will trim off the longest 5% of
trips so we can see the typical pattern of ride length.

**One observation is that casual riders make up almost all trips longer than 40 
minutes!**

**TODO: is there some limitation on ride length for members? The cutoff
around 40 minutes looks quite sudden.**

One question to arise from this: what sort of bike is most comfortable for
long trips, and which are better for short ones?  Do members tend to choose
lighter, speedier bikes and do casuals prefer bikes with more comfort?

```{r trip duration histogram}
df %>% 
  group_by(member_casual) %>%  # IMPORTANT! Trim the top 5% of EACH GROUP, separately
  filter(trip_minutes < quantile(trip_minutes, 0.95)) %>% 
  ungroup() %>% 
  ggplot(aes(x = trip_minutes, fill = member_casual, color = member_casual)) +
  geom_histogram(bins = 40, alpha = 0.7) +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Ride durations",
       x = "Minutes",
       y = "Count of rides") +
  annotate(geom = "text", x = 70, y = 200000, label = "Members rarely ride more than 40 minutes") +
  annotate(geom = "curve", x = 50, y = 170000, xend = 40, yend = 9000, 
           curvature = 0.1, arrow = arrow(length = unit(.02, "npc")))
```

## Ride duration, by weekday

We see an unsurprising distribution of trip durations over the week: a slight 
increase over the weekend, with casual riders having showing a larger
difference.
```{r tuesday oddity}
df %>% 
  group_by(weekday, member_casual) %>% 
  summarise(mean_ride_length = mean(trip_minutes)) %>% 
  ggplot(aes(weekday, mean_ride_length, fill=member_casual)) +
  geom_col(position = position_dodge(width = 0.4), alpha = 0.8) + 
  labs(title = "Average Ride lengths over the week",
       x = NULL, y = "Average minutes") +
  theme(legend.position = "right", legend.title = element_blank() )
```

## Number of trips by day of the week
We see here that:

- Member use is fairly steady through the week
- Casual use increases on Friday and nearly doubles through the weekend.

We can take this as more evidence that members are often commuting,
whereas casuals are primarily riding for other reasons (enjoyment, exercise?)

```{r day of week, echo=FALSE}
df %>%
  ggplot(aes(weekday, fill = member_casual)) +
  geom_bar(position = position_dodge(width = 0.5), alpha = 0.8) +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Total Number of rides, by day",
       x=NULL, y = "Rides") +
  theme(legend.title = element_blank())
```

## Trips volume trend over the last year

- There is an enormous seasonal variation, from a low of 15 rides to a high of
almost 20,000 in one day.
- The trend in 2021 is for higher volume than 2020
- Casual membership seems to be rising more sharply in 2021
```{r daily trips, message=FALSE, echo=FALSE}
df %>% 
  group_by(date(started_at), member_casual) %>% 
  summarise(n_rides = n()) %>% 
  rename(date = 1) %>% 
  ggplot(aes(x = date, y = n_rides, color = member_casual)) +
  geom_point(alpha = 0.3) +
  geom_smooth(size=2, se = FALSE) + 
  labs(title = "Seasonal variation in bike usage",
       subtitle = "Daily trip volume, 2020-2021", 
       x = 'Date', y = "Rides") +
  theme(legend.title = element_blank())
```

## Do weekends matter?
Yes, but only for casuals and not in winter.

```{r do weekends matter, message=FALSE, echo=FALSE}
df %>% 
  mutate(is_weekend = as_factor(weekday %in% c('Saturday', 'Sunday'))) %>% 
  group_by(date(started_at), member_casual, is_weekend) %>% 
  summarise(n_rides = n()) %>% 
  rename(date = 1) %>% 
  ggplot(aes(x = date, y = n_rides)) +
  geom_point(alpha=0.2) +
  geom_smooth(aes(color = is_weekend), se = FALSE, size = 2) + 
  facet_wrap(~member_casual) +
  scale_color_brewer(palette="Set1") +
  labs(title = "Trip Volume: Weekend vs Weekday", 
       subtitle = "Weekends are king for casuals", 
       x = 'Date', y = "Rides",
       color = "Weekend?") +
  guides(color = guide_legend(reverse = TRUE))   # reverse legend order, TRUE first
```


## Do they differ in *what hour* rides are taken?
Not much. There seems to be a slight tendency for casuals to start their rides later.
The tendency is similar for ending times (not shown.)

```{r hour of trip start, echo=FALSE}
df %>% 
  ggplot(aes(x=member_casual, y=hour(started_at), fill = member_casual)) +
  geom_boxplot() +
  labs(x="", y = "Hour the trip started", title = "When do trips start?")
```


## Hour of trip start, in detail
Lending more weight to the 'members commute more often' hypothesis we see
two jumps in member activity, both starting around morning and evening
commute times.  Casual users have a much smoother increase in trips
as the day goes on. Two possible interpretations are that 
casuals are using a bike for their commute less often,
or casual users tend to have non-typical start times for their job.

```{r hour of trip start detailed, echo=FALSE}
df %>% ggplot(aes(hour(started_at), fill=member_casual)) +
  geom_bar(position = position_dodge(width=0.7), alpha = 0.8) +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "How many rides start in each hour?",
       x = "Hour", y = NULL) +
  annotate("text", x = 5, y = 220000, label = "Morning rush hour, members only!") +
  annotate("curve", x = 1, y = 210000, xend = 5.5, yend = 120000,
           curvature = 0.1, arrow = arrow(length = unit(0.07, "npc"))) +
  theme(legend.title = element_blank())
```


## Are some stations preferred by casuals?
Dramatically so! Some stations are 100% casual use and others are near-zero!
The median station is 42% casual use.

```{r station use, echo=FALSE}
df %>% 
  group_by(start_station_id, member_casual) %>% 
  summarise(n = n(), .groups = 'drop_last') %>% 
  mutate(percentage = n / sum(n) * 100) %>% 
  filter(member_casual == "casual") %>% 
  ggplot(aes(percentage)) + 
  geom_histogram(bins = 30, fill='deepskyblue') +
  labs(title="Distribution of station use",
       subtitle = "Stations vary from 100% casual to near-zero!",
       x = 'Percentage of casuals',
       y = 'Number of stations')
```

## Order all stations by popularity, plot the proportion of members using it

We see a clear pattern. As stations get busier, the proportion of casuals rises.
There is still a large amount of variability however.

```{r station popularity scatter and fit, echo=FALSE, message=FALSE}
df %>% 
  group_by(start_station_id, member_casual) %>% 
  summarize(n = n()) %>% 
  mutate(total = sum(n)) %>% 
  filter(member_casual == 'casual') %>% 
  mutate(casual_percent = n / total * 100,
         mostly_casual = casual_percent > 50) %>% 
  arrange(desc(total)) %>% 
  ggplot(aes(desc(rank(total)), casual_percent)) +
  geom_point(aes(color = mostly_casual)) +
  geom_smooth() +
  scale_x_continuous(breaks = NULL, name = "(-)     Station Popularity     (+)") +
  labs(x = 'Popularity of station', y = '% who are casuals',
       title = 'Percent of riders being casuals, by station popularity',
       subtitle = "The busier a station, the more often that casuals tend to use them")
```


## Plot stations on the map
ideas:

- Size of dot varies with station popularity
- the colour varies with the proportion of users (by trip start) who are casuals. 
  - First step: mostly_casual to colour the stations with binary scheme

```{r mapping the dataset, echo=FALSE, message=FALSE}

x2 <- df %>% 
  # slice_sample(n = 1000000) %>% 
  group_by(start_lng_sector, start_lat_sector, member_casual) %>% 
  summarise(avg_trip_mins = mean(trip_minutes), n_trips_sector = n()) %>% 
  filter(n_trips_sector > 4)  # remove some weird outliers

# use the summary you just calculated
# for a heatmap use bin2d and the identity stat -----------------------------
ggplot(boundaries_chi, aes()) + 
  geom_sf() +
  geom_bin2d(data = x2, stat = 'identity', bins=c(25,50),
             mapping = aes(start_lng_sector, start_lat_sector, fill= avg_trip_mins),
             alpha = 1) +
  scale_fill_viridis(option = 'plasma') +
  facet_wrap(~member_casual) +
  labs(title = "Length of trips starting here")

x3 <- df %>% 
  # slice_sample(n = 1000000) %>% 
  group_by(end_lng_sector, end_lat_sector, member_casual) %>% 
  summarise(avg_trip_mins = mean(trip_minutes), n_trips_sector = n()) %>% 
  filter(n_trips_sector > 4)  # remove some weird outliers

# heatmap: use bin2d and the identity stat -----------------------------
ggplot(boundaries_chi, aes()) + 
  geom_sf() +
  geom_bin2d(data = x3, stat = 'identity', bins=c(25,50),
             mapping = aes(end_lng_sector, end_lat_sector, fill= avg_trip_mins),
             alpha = 1) +
  scale_fill_viridis(option = 'plasma') +
  facet_wrap(~member_casual) +
  labs(title = "Length of trips ending here")


# let the geom (hexbin, 2d density, count) do the aggregation from raw lng/lat
boundaries_chi %>% ggplot(aes()) + 
  geom_sf() +
  geom_bin2d(data = df, mapping = aes(start_lng, start_lat), bins=c(25,50)) +
  scale_fill_viridis(option = 'plasma') +
  facet_wrap(~member_casual) +
  theme(panel.background = element_rect(fill = "white")) +
  labs(title="Number of trips started in this area")

# TRIP ENDS
ggplot(boundaries_chi, aes()) + 
    geom_sf() +
    geom_bin2d(data = df, mapping = aes(end_lng, end_lat),  bins=c(25,50)) +
  scale_fill_viridis(option = 'plasma') +
  facet_wrap(~member_casual) +
  theme(panel.background = element_rect(fill = "white")) +
  labs(title="Number of trips ended in this area")

# TRIP starts and ends in the same station
# see how there is a huge spike of round tripping casuals right in that one area
pleasure_cruises <- df %>% 
  filter(is_round_trip == 'round trip')
ggplot(boundaries_chi, aes()) + 
  geom_sf() +
  # geom_hex(data = pleasure_cruises,
  #           mapping = aes(end_lng, end_lat)) +
  geom_bin2d(data = pleasure_cruises, mapping = aes(end_lng, end_lat), bins=c(25,50)) +
  scale_fill_viridis(option = 'plasma') +
  facet_wrap(~member_casual) +
  theme(panel.background = element_rect(fill = "white")) +
  labs(title="Number of trips started & ended at the same station")
rm(pleasure_cruises)

# TRIP starts and ends in different places: map start point
a_to_b <- df %>% 
  filter(is_round_trip == 'a to b')
ggplot(boundaries_chi, aes()) + 
  geom_sf() +
  # geom_hex(data = a_to_b,
  #          mapping = aes(start_lng, start_lat)) +
  geom_bin2d(data = a_to_b, mapping = aes(start_lng, start_lat), bins=c(25,50)) +
  scale_fill_viridis(option = 'plasma') +
  facet_wrap(~member_casual) +
  theme(panel.background = element_rect(fill = "white")) +
  labs(title="Number of trips started here and ending elsewhere")
# TRIP starts and ends in different places: map END point
ggplot(boundaries_chi, aes()) + 
  geom_sf() +
  # geom_hex(data = a_to_b,
  #          mapping = aes(end_lng, end_lat)) +
  geom_bin2d(data = a_to_b, mapping = aes(end_lng, end_lat), bins=c(25,50)) +
  scale_fill_viridis(option = 'plasma') +
  facet_wrap(~member_casual) +
  theme(panel.background = element_rect(fill = "white")) +
  labs(title="Number of trips started elsewhere & ended here")
rm(a_to_b)

# Facet on membership & is_round_trip
# 42 & 25 are the number of rectangular sectors
ggplot(boundaries_chi, aes()) + 
  # geom_sf() +
  geom_bin2d(data = df, mapping = aes(start_lng, start_lat),  bins=c(25,50)) +
  scale_fill_viridis(option = 'plasma') +
  facet_wrap(~member_casual + is_round_trip, scales = 'free', ) +
  theme(panel.background = element_rect(fill = "white"), aspect.ratio = 42/25) +
  labs(title="Number of trips that started here")
ggplot(boundaries_chi, aes()) + 
  # geom_sf() +
  geom_bin2d(data = df, mapping = aes(end_lng, end_lat), bins=c(25,50)) +
  scale_fill_viridis(option = 'plasma') +
  facet_wrap(~member_casual + is_round_trip, scales = 'free', ) +
  theme(panel.background = element_rect(fill = "white"), aspect.ratio = 42/25) +
  labs(title="Number of trips that ended here")

# make a station density map
stations <- df %>% 
  group_by(start_station_id, member_casual) %>% 
  summarise(station_lng = mean(start_lng), 
            station_lat = mean(start_lat),
            n_trips = n(),
            mean_duration = mean(trip_minutes),
            log_mean_duration  = log2(mean_duration)) %>% 
  filter(n_trips > 10)  # remove stations w/o enough data
stations_sectored <- df %>% 
  group_by(start_lng_sector, start_lat_sector, member_casual) %>% 
  summarise(n_trips = n(),
            mean_duration = mean(trip_minutes),
            log_mean_duration = log2(mean_duration)) %>% 
  filter(n_trips > 10)
stations_sectored_end <- df %>% 
  group_by(end_lng_sector, end_lat_sector, member_casual) %>% 
  summarise(n_trips = n(),
            mean_duration = mean(trip_minutes),
            log_mean_duration = log2(mean_duration)) %>% 
  filter(n_trips > 10)

ggplot(boundaries_chi, aes()) +
  geom_sf() +
  geom_bin2d(data = stations, mapping = aes(station_lng, station_lat), bins=c(25,50)) +
  scale_fill_viridis(option= 'plasma') +
  labs(title = 'Station density')

# trip durations map -------------
# individual stations - 'scatterplot'
ggplot(boundaries_chi, aes()) +
  geom_sf() +
  geom_point(data = stations,
             mapping = aes(station_lng, station_lat, color = mean_duration)) +
  scale_color_viridis(option= 'plasma') +
  labs(title = 'Mean duration of trips started here')
# stations binned into sectors
ggplot(boundaries_chi, aes()) +
  geom_sf() +
  geom_bin2d(data = stations_sectored, stat = 'identity',  bins=c(25,50),
             mapping = aes(start_lng_sector, start_lat_sector, fill = mean_duration)) +
  scale_fill_viridis(option= 'plasma') +
  labs(title = 'Mean duration of trips started here')
# stations binned into sectors & mean_duration log-transformed
ggplot(boundaries_chi, aes()) +
  geom_sf() +
  geom_bin2d(data = stations_sectored, stat = 'identity',
             mapping = aes(start_lng_sector, start_lat_sector, fill = log_mean_duration)) +
  scale_fill_viridis(option= 'plasma') +
  labs(title = 'Mean duration of trips started here (log-transformed duration)')
# stations binned into sectors & mean_duration log-transformed - by ENDING station
ggplot(boundaries_chi, aes()) +
  geom_sf() +
  geom_bin2d(data = stations_sectored_end, stat = 'identity',
             mapping = aes(end_lng_sector, 
                           end_lat_sector, 
                           fill = log_mean_duration)) +
  scale_fill_viridis(option= 'plasma') +
  labs(title = 'Mean duration of trips ended here (log-transformed duration)')

# Station density map again, simpler?
# Does the counts (rides starting in a bin) quite nicely.
boundaries_chi %>% ggplot() +
  geom_sf() +
  geom_bin2d(data = stations, aes(x = station_lng, y = station_lat),
             bins = c(25,50)) +
  scale_fill_viridis(option= 'turbo') +
  labs(title = "Station density")

# What I'd like to do though is calculate a stat for each CALCULATED BIN.
# Like, the program bins all the coordinates and I want a mean of
# mean_duration for all observations in the bin. Right now the default
# is just to count observations in the bin.
boundaries_chi %>% ggplot() +
  geom_sf() +
  geom_hex(data = stations, aes(x = station_lng, y = station_lat), bins = c(18,24)) +
  scale_fill_viridis(option= 'turbo') +
  labs(title = "Station density")

# Sorting the data by p_trips_casual controls the order that dots are plotted
# in the map in the next code block. This is important because of overplotting.
# When stations are plotted in this order, the last stations to be plotted
# are on top. 
# The business task is to increase casual use, and this method ensures we 
# see the high casual use stations when the map is crowded. 
stations_users <- stations %>% 
  group_by(start_station_id) %>%
  mutate(p_trips_casual = n_trips / sum(n_trips),
         n_trips_station = sum(n_trips)) %>% 
  filter(member_casual == "casual") %>% 
  rename(n_trips_casual = n_trips) %>% 
  arrange(p_trips_casual)

# Map station usage: colour stations by casual use percentage (ride start)
boundaries_chi %>% ggplot() +
  geom_sf() +
  geom_point(data = stations_users, 
             mapping = aes(x = station_lng, y = station_lat,
                           color = p_trips_casual)) +
  scale_color_viridis(option = "turbo", labels = scales::percent) +
  labs(title = "Who uses each station?",
       subtitle = "Casual usage at each station",
       color = "Casual use\n")

# Map the casual hot spots: stations over 75% casual use
boundaries_chi %>% ggplot() +
  geom_sf() +
  geom_point(data = stations_users, 
             mapping = aes(x = station_lng, y = station_lat,
                           color = p_trips_casual > .75)) +
  # scale_color_viridis(option = "jet", discrete = TRUE) +
  scale_color_discrete(type=c("deepskyblue4", "red")) +
  # scale_color_brewer(palette = "Set1", direction = -1) +
  guides(color = guide_legend(reverse = TRUE)) +  # reverse legend order, TRUE first
  labs(title = "Casual use hot spots",
       subtitle = "Stations over 75% casual use",
       color = "Over 75% casual use")
```

## Average rider motion by hour
Here we'll examine the overall traffic flow: as the hours go by, do riders tend
to ride in a particular direction?  **Yes!** Overall it
seems like there is a daily tendency for riders (and bicycles) to move
northwest.

### TODO: make interpretable with distance
This has connections with how Divvy may have to shuttle bikes around at night
to ensure the busy stations have bikes

- the average rider (and bike!) moves Xm west by northwest
- overall, traffic moves Xm west by northwest

```{r create motion vectors}
angle_from_x_axis <- function(y,x) {
  angle <- atan(y/x)
  if (x<0) {
    angle <- angle + pi
  } else if (x>=0 & y<0) {
    angle <- angle + 2*pi
  } 
  angle * 180 / pi
}
# trend over the entire dataset
overall_vec <- df %>% 
  summarize(x = sum(trip_delta_x), 
            y = sum(trip_delta_y),
            mean_x = mean(trip_delta_x),
            mean_y = mean(trip_delta_y),
            magnitude = sqrt(x^2 + y^2),
            angle = angle_from_x_axis(y,x),
            atan = atan(y/x))
# monthly trends
monthly_vec <- df %>% 
  group_by(month = lubridate::month(started_at),
           hour = lubridate::hour(started_at)) %>% 
  summarize(x = sum(trip_delta_x), 
            y = sum(trip_delta_y),
            mean_x = mean(trip_delta_x),
            mean_y = mean(trip_delta_y),
            magnitude = sqrt(x^2 + y^2),
            angle = angle_from_x_axis(y,x),
            atan = atan(y/x))
# day-of-the-week plus hour trends
dow_vec <- df %>% 
  group_by(weekday,
           hour = lubridate::hour(started_at)) %>% 
  summarize(x = sum(trip_delta_x), 
            y = sum(trip_delta_y),
            mean_x = mean(trip_delta_x),
            mean_y = mean(trip_delta_y),
            magnitude = sqrt(x^2 + y^2),
            angle = angle_from_x_axis(y,x),
            atan = atan(y/x))
# hourly trends
vecs <- df %>% 
  group_by(hour = lubridate::hour(started_at)) %>% 
  summarize(x = sum(trip_delta_x), 
            y = sum(trip_delta_y),
            mean_x = mean(trip_delta_x),
            mean_y = mean(trip_delta_y),
            magnitude = sqrt(x^2 + y^2),
            angle = angle_from_x_axis(y,x)) 
```

## Overall traffic flow by hour
We compute an estimate of the overall flow of traffic (direction and distance) 
for every trip taken each hour.  We see the strong signals for the morning
and evening commutes, with the evening being larger.  This probably leads to
bicycles being distributed over the city unequally, with a bias towards the
northwest.

*Technical note: This is done by adding the
vectors of every trip up to compute the 'overall trip' during that hour*

```{r traffic flow by hour}
ggplot(vecs, aes(x=0, y=0, xend=x, yend=y)) +
  geom_hline(yintercept = 0, color = 'gray80') +
  geom_vline(xintercept = 0, color = 'gray80') +
  facet_wrap(~hour, ncol = 6) +
  theme_gray() +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_blank()) +
  geom_segment(arrow = arrow(length = unit(0.1, "npc")), color='blue') +
  coord_fixed(ratio = 0.7) +
  labs(title = "Overall traffic direction and strength, by hour")
```

## Traffic flow by hour and weekday
Between 4pm and 6pm, notice the distinct difference in traffic flow on the
weekend.

```{r Traffic flow by hour and weekday}
ggplot(dow_vec, aes(x=0, y=0, xend=x, yend=y, color=as_factor(weekday))) +
  geom_hline(yintercept = 0, color = 'gray80') +
  geom_vline(xintercept = 0, color = 'gray80') +
  theme_gray() +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_blank()) +
  geom_segment(arrow = arrow(length = unit(0.1, "npc"))) +
  facet_wrap(~hour, ncol = 6) +
  labs(title = "Overall traffic direction and strength, by hour and weekday",
       caption = "Note the variation on different days between 4-6pm") +
  scale_color_viridis(discrete = TRUE, option="turbo")
```

## Examining the evening rush hour traffic
The rush hour traffic flow has two main patterns.

- On **Monday to Friday**, evening rush hour traffic trends strongly to the northwest.
- On **weekends** it trends west to southwest

```{r Traffic flow by hour and weekday limited to rush hour}
dow_vec %>%
  filter(between(hour, 16, 18)) %>%
  ggplot(aes(
    x = 0,
    y = 0,
    xend = x,
    yend = y,
    color = as_factor(weekday)
  )) +
  geom_hline(yintercept = 0, color = 'gray80') +
  geom_vline(xintercept = 0, color = 'gray80') +
  theme_gray() +
  theme(
    axis.text = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    panel.background = element_blank()
  ) +
  geom_segment(arrow = arrow(length = unit(0.1, "npc"))) +
  facet_wrap( ~ hour) +
  labs(title = "Rush hour traffic direction and strength",
       subtitle = "Evening rush hour: 4 - 6pm",
       caption = "Weekends have their own distinct pattern") +
  scale_color_viridis(discrete = TRUE, option = "turbo")
```

## Hourly traffic flow, with monthly patterns
Not useful. Traffic flow doesn't notably vary by month, other than in magnitude.

```{r traffic flow by hour and month}
ggplot(monthly_vec, aes(x=0, y=0, xend=x, yend=y, color=as_factor(month))) +
  geom_hline(yintercept = 0, color = 'gray80') +
  geom_vline(xintercept = 0, color = 'gray80') +
  theme_gray() +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_blank()) +
  geom_segment(arrow = arrow(length = unit(0.1, "npc"))) +
  facet_wrap(~hour) +
  labs(title = "Overall traffic direction and strength, by hour",
       subtitle = "Colours denote months",
       caption = "Little variation by month: the main effect is the hour")
```


## TODO

- ADD FEATURE: Calculate mean straight-line **distance** of trips started and ended in each
sector.
  - is it better to do straight line, or horizontal + vert distances
    ("manhattan distance") and add them?
- Bike Motion maps: calculate total "bike miles" moved in a certain direction
  to make the abstract arrows more concrete.
- visualize timelapse behaviour
  - trips starting from a sector, with scrubbable hour (tableau!)
    - or as an animation
  - and similarly, ending at a sector..
  - Can you draw a map of LINES connecting start and end points for
    trips..?
    - or similarly, for e.g. 4-4:59pm, a cloud of dots in two colours,
      trips started and trips ended, at every location.
- a map of all stations, coloured by the proportion of casual users who
  start/end trips at this station.
  - size the dots based on the popularity of the station (# of trips
  starting/ending there)
- find the fastest rides:
  - use trip time and straight-line distance
- is there a 'mean travel direction'?
  - like, morning tends to go north, 5pm it switches?
  - calculate by the hour and draw an arrow with direction and strength?
    - seems like vectors would work... and we have all the components!
      - start_lng, start_lat, end_lng, end_lat
      - this is a vector with angle arctan(delta_y/delta_x) (Quadrant!) and
        magnitude sqrt(delta_x^2 + delta_y^2)
      - BETTER: just add up all the delta_x and delta_y componenets of every
      trip in that hour and you end up with a vector pointing to the
      overall (sum of) trip direction and distance.














