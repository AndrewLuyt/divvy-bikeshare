---
title: "Analysis: How Casual Users and Members Differ"
author: "Andrew Luyt"
date: "2021-07-29"
output: 
  html_document:
    keep_md: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r load data, include=FALSE}
library(tidyverse)
library(lubridate)
library(data.table)
library(sf)
library(here)
library(viridis)
library(ggrepel)
library(gganimate)

Mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}

# not vectorized, use rowwise()
# TODO: Vectorize.
angle_from_x_axis <- function(y,x) {
  angle <- atan2(y, x)
  if (y<0) {
    angle <- angle + 2 * pi
  } 
  angle * 180 / pi
}

Truncate <- function(x, ndigits = 1) {
  trunc(x*10^ndigits)/10^ndigits
}

# Normal 2-digit precision sectors were too small, 1-digits are too big.
# coord %% 2 == 1 --> 2x as wide & tall
Sector <- function(coord) {
  coord <- round(coord * 100, 0)
  indices <- coord %% 2 == 1
  coord[indices] <- 
    sign(coord[indices]) *
    (abs(coord[indices]) + 1)
  coord / 100
}

x.txt.size = 13  # scale the x axis ticks in many graphs

DATA = here("data/alldata.csv.gz")
df <- fread(
  DATA,
  colClasses = c(start_station_id = 'character'),
  # Optimize: Some features ended up not being used, so let's skip them.
  drop = c("rideable_type", "ended_at", "end_station_name", "end_station_id", 
           "end_lat", "end_lng", "end_lat_sector", "end_lng_sector"),
  stringsAsFactors = TRUE,
  showProgress = FALSE
)

# put the factors in convenient order now, else we'll have to do this
# every time we make a plot using the weekday.
df <- df %>%
  mutate(
    weekday = fct_relevel(weekday,
                          c("Monday", "Tuesday", "Wednesday", "Thursday", 
                            "Friday", "Saturday", "Sunday")),
    month = fct_relevel(month, 
                        c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", 
                          "Aug", "Sep", "Oct", "Nov", "Dec")))

# Chicago neighbourhood boundaries as Simple Features. We only need
# the geometry for mapping, all the attributes can be discarded.
boundaries_chi = st_read(here("data/Chicago_Boundaries-Neighborhoods.geojson"),
                         quiet = TRUE)
boundaries_chi <- boundaries_chi %>%
  select(geometry)
```

```{r theming}
default_theme <- theme_set(theme_bw())
theme_update(panel.grid = element_blank(),
             legend.justification = "top",
             plot.title = element_text(size=14, face="bold"))

theme_map <- theme_bw() +
  theme(axis.title = element_blank(), 
        axis.text = element_blank(), 
        axis.ticks = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_rect(fill = 'white'),
        plot.title = element_text(size=14, face="bold"),
        legend.justification = "top")

theme_map_dark <- theme_bw() +
  theme(axis.title = element_blank(), 
        axis.text = element_blank(), 
        axis.ticks = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_rect(fill = 'grey40'),
        plot.title = element_text(size=14, face="bold"),
        legend.justification = "top")
```

## Executive Summary
Comparing casual users with members we find a few notable differences.

-todo

## Who rides most often?
Overall, members take the majority of rides. 


```{r who rides most often, echo=FALSE, message=FALSE, fig.width=7}
df %>% 
  group_by(member_casual) %>% 
  summarise(n = n()) %>% 
  ggplot(aes(x = member_casual, y = n, fill = member_casual)) +
  geom_col() +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Total number of rides",
       subtitle = paste("Since", lubridate::month(min(df$started_at), label = TRUE),
                        year(min(df$started_at))),
       x = NULL, y = "Rides") +
  geom_text(aes(label = scales::comma(n)), 
            vjust = 2.1,
            size = 5) +
  theme(axis.text.x = element_text(size = x.txt.size),
        legend.position = "none")
```

Casual use doubles on the weekend, even exceeding member use. 


```{r who rides most often 2, echo=FALSE, message=FALSE, fig.width=7}
df %>% 
  group_by(member_casual, weekday) %>% 
  summarise(n = n()) %>% 
  ggplot(aes(x = weekday, y = n, fill = member_casual)) +
  geom_col(position = "dodge") +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Total number of rides on each day of the week",
       subtitle = paste("Since", lubridate::month(min(df$started_at), label = TRUE),
                        year(min(df$started_at))),
       x = NULL, y = "Rides") +
  theme(axis.text.x = element_text(),
        legend.title = element_blank())
```

Breaking down the number of rides by month, we can see that while the season
is important for all riders, casual users are much less willing to ride in
the winter months. From December to February, the system sees very little casual use.


```{r who rides most often 3, echo=FALSE, message=FALSE, fig.width=7}
df %>% 
  filter(started_at >= "2020-07-01") %>% 
  group_by(member_casual, month) %>% 
  summarise(n = n()) %>% 
  ggplot(aes(x = month, y = n, fill = member_casual)) +
  geom_col(position = "dodge") +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Total number of rides each month",
       subtitle = "Since July 2020",
       x = NULL, y = "Rides") +
  theme(legend.title = element_blank())
```


**Summarizing the previous three graphs**, casual use of the system is much
more variable than for members. It is maximized
during summer weekends and minimized during winter weekdays.

## How do trip distances vary?

This is a bit surprising.  For trips that start and end at different stations,
the average trip is about the same distance for both classes of users, about 
two and a half kilometers.  


```{r avg trip distance, echo=FALSE, message=FALSE, fig.width=7}
df %>% 
  filter(is_round_trip == 'a to b') %>% 
  group_by(member_casual) %>% 
  summarise(mean_trip_distance = mean(trip_distance)) %>% 
  ggplot(aes(member_casual, mean_trip_distance, fill = member_casual)) +
  geom_col() +
  labs(title = "Average trip distance (Km)",
       subtitle = "Straight-line distance from start to end stations",
       x = NULL, y = "Kilometers") +
  geom_text(aes(label = round(mean_trip_distance, digits = 1)), 
            vjust = 2.1,
            size = 5) +
  theme(legend.position = "none",
        axis.text.x = element_text(size = x.txt.size))
```


Seasonally, average trip distance is smallest during the winter and largest in 
summer, but only by about half a kilometer. Trip distance does not change much
over the course of the week.

### A special case: pleasure cruises?

For the above analysis we removed trips that start and end 
at the same station since, lacking GPS data to track the ride, they have an 
apparent distance of zero. We believe it's likely that pleasure cruises make up
a large portion of these rides. These rides average an hour long for casual users.
In the next section on ride duration we'll see the average of all casual trips is just
over 30 minutes, an interesting difference.


```{r pleasure cruise caveat, results='asis'}
tmp <- df %>% 
  group_by(member_casual, is_round_trip) %>% 
  summarise(n_trips = n(), 
            avg_trip_minutes = round(mean(trip_minutes), 0)) %>% 
  mutate(percent_of_trips = n_trips / sum(n_trips)) %>% 
  filter(is_round_trip == 'round trip') %>% 
  select(member_casual, n_trips, avg_trip_minutes, percent_of_trips) %>% 
  rename("Rider Type" = member_casual,
         "Possible pleasure cruises" = n_trips,
         "Avg trip minutes" = avg_trip_minutes,
         "Percent of trips" = percent_of_trips)
tmp$`Percent of trips` <- scales::percent(tmp$`Percent of trips`, accuracy = .1)
tmp %>% 
  knitr::kable() %>% 
  kableExtra::kable_styling(full_width = FALSE)
rm(tmp)
```

These round-trips represent about 10% of 
all bike use and about **15% of all casual use.** We also see above that casual 
users outnumber members 3 to 1 in this interesting subset of rides. We'll 
return to these trips in a later section, after we have explored ride duration.

## How much *time* is spent on an average ride?
Casuals ride more than twice as long as members, on average.  


```{r mean ride duration, echo=FALSE}
df %>% 
  group_by(member_casual) %>% 
  summarise(mean_ride_length = mean(trip_minutes)) %>% 
  ggplot(aes(member_casual, mean_ride_length, fill = member_casual)) +
  geom_col() +
  labs(title = "Average ride duration (minutes)",
       x = NULL, y = "Minutes") +
  geom_text(aes(label = round(mean_ride_length, digits = 1)), 
            vjust = 2.1,
            size = 5) +
  theme(legend.position = "none",
        axis.text.x = element_text(size = x.txt.size))
```

Seasonally, casual rides have a large amount of variation. The small number of
winter trips taken tend to be short - half the length of rides at the peak of summer.

```{r mean ride duration 2, echo=FALSE, message=FALSE}
df %>% 
  group_by(member_casual, month) %>% 
  summarise(mean_ride_length = mean(trip_minutes)) %>% 
  ggplot(aes(month, mean_ride_length, fill = member_casual)) +
  geom_col() +
  labs(title = "Average ride duration (minutes)",
       x = NULL, y = "Minutes") +
  geom_text(aes(label = round(mean_ride_length, digits = 0)), 
            vjust = 2.1,
            size = 4) +
  theme(axis.text.x = element_text(size = x.txt.size),
        legend.title = element_blank())
```

## Pleasure cruises?

Earlier we noted the possibility that 10% of all rides (and 15% of casual
rides) were round-trip
pleasure cruises starting and ending at the same station, likely near the
rider's home. The two graphs below provide more evidence for this idea.

If our hypothesis is correct, the percentage of this type of ride should shrink
in winter and grow in summer and be mostly confined to casual users.  This
first graph shows exactly this pattern.


```{r pleasure cruises, echo=FALSE, message=FALSE}
df %>% 
  group_by(month, member_casual, is_round_trip) %>% 
  summarise(n = n()) %>% 
  mutate(percent_of_rides = n / sum(n) * 100) %>% 
  filter(is_round_trip == "round trip") %>%
  ggplot(aes(x = month, y = percent_of_rides, fill = member_casual)) +
  geom_col() +
  facet_wrap(~member_casual, ncol = 2) +
  labs(title = "Pleasure cruises over the seasons",
       subtitle = "Percentage of all trips starting and ending at the same station",
       x = NULL, y = "Percent of rides that are round-trip") +
  theme(legend.position = "none")
```


Second, if our idea is correct we should also see trip duration becoming longer
in summer and shorter in winter. This should strongly affect casual users but
have little effect on members, who have a 45-minute time limit.  This graph
demonstrates this pattern as well.


```{r pleasure cruises 2, echo=FALSE, message=FALSE}
df %>% 
  group_by(month, member_casual, is_round_trip) %>% 
  summarise(avg_ride_minutes = mean(trip_minutes)) %>% 
  filter(is_round_trip == "round trip") %>%
  ggplot(aes(x = month, y = avg_ride_minutes, fill = member_casual)) +
  geom_col() +
  facet_wrap(~member_casual, ncol = 2) +
  labs(title = "Duration of pleasure cruises",
       subtitle = "Seasonal variation is readily apparent",
       x = NULL, y = "Minutes") +
  theme(legend.position = "none")
```


Going further to learn how these rides differ in destination, length, or speed would require 
some sort of GPS tracking data from the bikes, which is outside the scope of 
this dataset.  For now we note the strong possibility that **about ten percent
of all trips are taken for enjoyment rather than travel, and that casual users
dominate this market segment.**

## Speed, Time in the Saddle, Comfort

We've seen that casuals and members ride about the same distances, but members
spend less time on the bikes. The graph below shows that members are about
30% faster on average.


```{r mean trip speed}
df %>% 
  filter(is_round_trip == 'a to b') %>%  # round trips have a distance of 0
  mutate(kph = trip_distance / (trip_minutes / 60)) %>% 
  group_by(member_casual) %>% 
  summarise(mean_kph = mean(kph)) %>% 
  ggplot(aes(member_casual, mean_kph, fill = member_casual)) +
  geom_col() +
  labs(title = "Mean trip speed (Kph)",
       subtitle = "Members ride about 30% faster",
       x = NULL, y = "Kilometers per hour") +
  geom_text(aes(label = round(mean_kph, digits = 1)), 
            vjust = 2.1,
            size = 5) +
  theme(legend.position = "none",
        axis.text.x = element_text(size = x.txt.size))
```

We now know that members ride more often and casuals ride longer - so who rides the 
most total minutes?  Casual users do!


```{r saddle time}
df %>% group_by(member_casual) %>% 
  summarise(total_minutes = sum(trip_minutes)) %>% 
  ggplot(aes(member_casual, total_minutes, fill= member_casual)) +
  geom_col() +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Who is in the saddle the longest?",
       subtitle=paste("Total minutes ridden since", 
                      lubridate::month(min(df$started_at), label = TRUE),
                      year(min(df$started_at))),
       x = NULL,
       y = "Total Minutes") +
  stat_summary(fun = sum, 
               geom="text", 
               aes(label=scales::comma(total_minutes)), vjust = 2, size=5) +
  theme(legend.position = "none", 
        axis.text.x = element_text(size=x.txt.size))
```

Since casual users spend so much more time in the saddle, it might be a
worthwhile experiment to trial a set of more comfortable, relaxed-ride bikes
aimed at users who want to cruise in comfort.  In the maps section below we
identify regions of the city where casual users dominate the ridership.

## Which stations do casual users choose?

Here we map all the bike stations in the system and colour them by the
percentage of casual rides that start there.

```{r mapping the dataset 8}
# make a station density map
# create some convenient tibbles for mapping.
# Bike stations with location, trips, mean duration
stations <- df %>% 
  group_by(start_station_id, member_casual) %>% 
  summarise(start_station_name = Mode(start_station_name),
            station_lng = mean(start_lng),  # there is GPS error in coords
            station_lat = mean(start_lat),
            n_trips = n(),
            mean_duration = mean(trip_minutes)) %>% 
  filter(n_trips > 10)  # remove stations w/o enough data
# RECTANGULAR SECTORS which bin bike stations inside them
stations_sectored <- df %>% 
  group_by(start_lng_sector, start_lat_sector, member_casual) %>% 
  summarise(n_trips = n(),
            mean_duration = mean(trip_minutes)) %>% 
  filter(n_trips > 10)

# Finally, a tibble with casual user % at each station
# Sorting the data by p_trips_casual controls the order that dots are plotted
# in the map in the next code block. This is important because of overplotting.
# When stations are plotted in this order, the last stations to be plotted
# are on top. 
# The business task is to increase casual use, and this method ensures we 
# see the high casual use stations when the map is crowded. 
stations_users <- stations %>% 
  group_by(start_station_id) %>%
  mutate(p_trips_casual = n_trips / sum(n_trips),
         n_trips_station = sum(n_trips)) %>% 
  filter(member_casual == "casual") %>% 
  rename(n_trips_casual = n_trips) %>% 
  arrange(p_trips_casual)
```

```{r casual usage map, echo=FALSE, message=FALSE, warning=FALSE}
# Map station usage: colour stations by casual use percentage (ride start)
boundaries_chi %>% ggplot() +
  geom_sf(fill = "grey95") +
  geom_point(data = stations_users, 
             mapping = aes(x = station_lng, y = station_lat,
                           fill = p_trips_casual),
             color = 'black',
             pch = 21,
             size = 2.5) +
  scale_fill_viridis(option = "viridis", labels = scales::percent) +
  labs(title = "Casual usage at each station",
       fill = "Casual use\n") +
  theme_map
```

Next let's highlight hot spots.  We'll plot only stations with over 70% casual 
use and we'll also give busier stations larger dots.


```{r casual usage map over 70}
# Map the casual hot spots: stations over 75% casual use
stations_users %>% 
  filter(p_trips_casual > .7) %>% 
  ggplot() +
  geom_sf(data = boundaries_chi, inherit.aes = FALSE,fill = "grey95") +
  geom_point(mapping = aes(x = station_lng, y = station_lat, size = n_trips_station),
             color="black", fill = "red", pch=21) +
  scale_size_continuous(range = c(1.5,9)) +
  labs(title = "Stations with over 70% casual use",
       subtitle = "Larger circles are busier stations",
       fill = "Over 70% casual use",
       size = "Number of trips") +
  theme_map +
  theme(legend.position = "none")
```

Finally let's zoom in on the notable hot spot near Navy Pier.  Of all stations with
over 70% casual use, these are the busiest.


```{r casual usage hot spot zoom, echo=FALSE, message=FALSE, warning=FALSE}
# Map the BUSY casual hot spots
NRIDES = 500
PCASUAL = 0.7
stations_users_busy <- stations %>% 
  filter(n_trips > NRIDES) %>% 
  group_by(start_station_id) %>%
  mutate(p_trips_casual = n_trips / sum(n_trips),
         n_trips_station = sum(n_trips)) %>% 
  filter(member_casual == "casual",
         p_trips_casual > PCASUAL) %>% 
  rename(n_trips_casual = n_trips) %>% 
  arrange(p_trips_casual)
```

```{r mapping the dataset 16, echo=FALSE, message=FALSE, warning=FALSE}
boundaries_chi %>% ggplot() +
  geom_sf(fill = "grey95") +
  geom_point(data = stations_users_busy, 
             mapping = aes(x = station_lng, y = station_lat,
                           size = n_trips_casual),
             fill = 'red',
             color = 'black',
             shape = 21) +
  geom_label_repel(data = stations_users_busy, 
            mapping = aes(x = station_lng, y = station_lat, label = start_station_name),
            nudge_x = -0.005,
            box.padding = .5) +
  scale_size_continuous(range = c(4, 10)) +
  scale_size_continuous(range = c(4, 10)) +
  labs(title = "Casual use hot spots on the waterfront",
       subtitle = "The most popular casual use destinations in Chicago",
       size = "Casual trips") +
  ylim(c(41.86, 41.90)) +
  xlim(c(-87.67, -87.59)) +
  theme_map +
  theme(axis.title = element_blank(), 
        axis.text = element_blank(), 
        axis.ticks = element_blank(),
        )
```

These stations are all on and around the waterfront between Soldier Field and
Navy Pier. They represent what is easily the most popular casual use desination
anywhere in the city, demonstrating a consistent pattern of activity by casual
users of the system.

## Traffic Flow: daily patterns
In our last piece of analysis we will examine the overall traffic flow for
patterns.  First up, traffic volume at all stations.

```{r all traffic volume mapped}
volume <- df %>% 
  # busiest day of the year is day 170 (June 19)
  filter(lubridate::year(started_at) == 2021, lubridate::yday(started_at) == 170) %>%
  # filter(lubridate::hour(started_at) > 11, lubridate::hour(started_at) < 15) %>%
  # filter(lubridate::year(started_at) == 2021, between(lubridate::yday(started_at), 168, 170)) %>%
  select(started_at, start_station_id, start_lng, start_lat, member_casual) %>% 
  mutate(minute = minute(started_at),     # round time into bins
         # minute = cut_interval(minute, n = 4, 
         #                       labels = c("00","15","30","45")),
         minute = cut_interval(minute, n = 3, 
                               labels = c("00","20","40")),
         started_at = 
           parse_date_time(paste0(lubridate::date(started_at), " ", 
                                  lubridate::hour(started_at), ":", minute),
                           "Ymd HM")) %>% 
  group_by(start_station_id) %>%   # station coordinates have error, create canonical coords
  mutate(start_lng = mean(start_lng),
         start_lat = mean(start_lat)) %>% 
  group_by(start_station_id, started_at, member_casual) %>% 
  summarise(n = n(),
            start_lng = first(start_lng),
            start_lat = first(start_lat)) %>% 
  mutate(total_trips = sum(n),
         p_casual = n / total_trips) %>% 
  filter(member_casual == "casual") %>%
  arrange(started_at, total_trips)  # for overplotting: last to be plotted are the largest # of trips
  # arrange(timecode, p_casual)  # for overplotting: last to be plotted are the highest casual %
  # arrange(timecode, p_casual * total_trips)  # for overplotting: last to be plotted are largest # of casuals

p <- volume %>% 
  ggplot(aes(x = start_lng,
             y = start_lat,
             group = started_at,  # important for gganimate!
             size = total_trips,
             fill = p_casual,
             color = p_casual)) +
  geom_sf(data = boundaries_chi, mapping = aes(), inherit.aes = FALSE, fill="grey60") +
  geom_point(pch = 21) +
  # scale_fill_distiller(palette = "RdYlBu", labels = scales::percent) +
  # scale_color_distiller(palette = "RdYlBu") +
  scale_fill_viridis(option = "viridis", labels = scales::percent) +
  scale_color_viridis(option = "viridis") +
  # scale_size_continuous(range = c(1.5, 10)) +
  scale_size_area(max_size = 12) +
  annotate("text", x = -87.865, y = 42.06, label = "CHICAGO", color = "grey60", cex = 10) +
  labs(subtitle = "This animation displays bike trips started at the more than 600 docking stations\nfor the Divvy bike sharing service. Colours display the percentage of user type\nat a station: casual users who purchase temporary passes vs annual members.",
       caption = "Andrew Luyt  2021  |  Source: Divvy") +
  ggtitle("Bicycle use on June 19, 2021    {previous_state}") +
  guides (color = "none", 
          fill = guide_colorbar("Casual users", order = 1),
          size = guide_legend(title = "Trips started", order = 2)) +
  theme_map_dark +
  transition_states(states = started_at, transition_length = 5, state_length = 0, wrap = TRUE) +
  enter_fade() + enter_grow() 

FPS = 30;W = 600;H = 660;DTL = 3;S = paste0(W,"x",H);NFRAMES = 3*24*1*5 # minutebins*hours*days*framesperbin
animate(plot = p, fps = FPS, nframes = NFRAMES, width = W, height = H, detail = DTL)
anim_save("img/traffic-volume-map.mp4", p, fps = FPS, nframes = NFRAMES,
          width=W, height=H, detail=DTL,
          renderer = ffmpeg_renderer(options = list(s = S, b = "1200k")))
anim_save("img/traffic-volume-map.gif", p, fps = FPS, detail = DTL, nframes = NFRAMES, width=W, height=H)
```

```{r all traffic volume mapped hispeed}
volume <- df %>% 
  # busiest day of the year is day 170 (June 19)
  filter(lubridate::year(started_at) == 2021, lubridate::yday(started_at) == 170) %>%
  # filter(lubridate::hour(started_at) > 10, lubridate::hour(started_at) < 13) %>%
  # filter(lubridate::year(started_at) == 2021, between(lubridate::yday(started_at), 168, 170)) %>%
  select(started_at, start_station_id, start_lng, start_lat, member_casual) %>% 
  mutate(minute = minute(started_at),     # round time into bins
         # minute = cut_interval(minute, n = 4, 
         #                       labels = c("00","15","30","45")),
         minute = cut_interval(minute, n = 3,
                               labels = c("00","20","40")),
         started_at = 
           parse_date_time(paste0(lubridate::date(started_at), " ", 
                                  lubridate::hour(started_at), ":", minute),
                           "Ymd HM")) %>% 
  group_by(start_station_id) %>%   # station coordinates have error, create canonical coords
  mutate(start_lng = mean(start_lng),
         start_lat = mean(start_lat)) %>% 
  group_by(start_station_id, started_at, member_casual) %>% 
  summarise(n = n(),
            start_lng = first(start_lng),
            start_lat = first(start_lat)) %>% 
  mutate(total_trips = sum(n),
         p_casual = n / total_trips) %>% 
  filter(member_casual == "casual") %>%
  arrange(started_at, total_trips)  # for overplotting: last to be plotted are the largest # of trips
  # arrange(timecode, p_casual)  # for overplotting: last to be plotted are the highest casual %
  # arrange(timecode, p_casual * total_trips)  # for overplotting: last to be plotted are largest # of casuals

p <- volume %>% 
  ggplot(aes(x = start_lng,
             y = start_lat,
             group = started_at,  # important for gganimate!
             size = total_trips,
             fill = p_casual,
             color = p_casual)) +
  geom_sf(data = boundaries_chi, mapping = aes(), inherit.aes = FALSE, fill="grey60") +
  geom_point(pch = 21) +
  # scale_fill_distiller(palette = "RdYlBu", labels = scales::percent) +
  # scale_color_distiller(palette = "RdYlBu") +
  scale_fill_viridis(option = "viridis", labels = scales::percent) +
  scale_color_viridis(option = "viridis") +
  # scale_size_continuous(range = c(1.5, 10)) +
  scale_size_area(max_size = 12) +
  annotate("text", x = -87.865, y = 42.06, label = "CHICAGO", color = "grey60", cex = 10) +
  labs(subtitle = "This animation displays bike trips started at the more than 600 docking stations\nfor the Divvy bike sharing service. Colours display the percentage of user type\nat a station: casual users who purchase temporary passes vs annual members.",
       caption = "Andrew Luyt  2021  |  Source: Divvy") +
  ggtitle("Bicycle use in June, 2021    {previous_state}") +
  guides (color = "none", 
          fill = guide_colorbar("Casual users", order = 1),
          size = guide_legend(title = "Trips started", order = 2)) +
  theme_map_dark +
  transition_states(states = started_at, transition_length = 1, state_length = 0, wrap = TRUE) +
  enter_fade() + enter_grow() 

FPS = 30;W = 600;H = 660;DTL = 3;S = paste0(W,"x",H);NFRAMES = 24*30 # minutebins*hours*days*framesperbin
animate(plot = p, fps = FPS, nframes = NFRAMES, width = W, height = H, detail = DTL)
anim_save("img/traffic-volume-map-june.mp4", p, fps = FPS, nframes = NFRAMES,
          width=W, height=H, detail=DTL,
          renderer = ffmpeg_renderer(options = list(s = S, b = "1200k")))
anim_save("img/traffic-volume-map-june.gif", p, fps = FPS, detail = DTL, nframes = NFRAMES, width=W, height=H)
```





## All traffic flow
When we look at the overall traffic flow for the city, it is remarkably
consistent, day to day and between members and casuals.  Traffic mostly flows in
to the waterfront from all directions, and flows out *from* the waterfront
either to the northwest or southwest, depending which side of Navy Pier
one is on.

Each arrow represents
overall motion of all the bikes during a 10-minute period.  An arrow pointing
northwest means that during that time the **average** motion of bikes is that direction.
The stronger the trend, the longer the arrow.

We'll first look at the big traffic patterns in the city.  Traffic flow from
bike stations surrounding each arrow have been aggregated together

```{r all traffic flow mapped sectored}
alltraffic <- df %>% 
  mutate(minute = minute(started_at),
         minute = cut_interval(minute, n = 6, 
                               labels = c("00","10","20","30","40","50"))) %>% 
  group_by(timecode = paste0(sprintf("%02d", lubridate::hour(started_at)), ":", minute),
           start_lng_sector = Sector(start_lng_sector), 
           start_lat_sector = Sector(start_lat_sector)) %>% 
  summarize(x = sum(trip_delta_x), 
            y = sum(trip_delta_y),
            mean_x = mean(trip_delta_x),
            mean_y = mean(trip_delta_y),
            magnitude = sqrt(x^2 + y^2)) %>% 
  ungroup() %>% rowwise() %>% 
  mutate(angle = angle_from_x_axis(y,x)) %>% 
  ungroup() %>% 
  mutate(angle = cut_interval(angle, n = 4, labels = 1:4)) %>%  # bin angles into 4 quadrants
  filter(magnitude >= 50) %>% # higher numbers make the map less cluttered
  arrange(timecode, desc(angle))

# We'll log-transform the size of the motion vectors so the huge ones don't
# completely dominate
p <- 
  ggplot(alltraffic, 
         aes(x = start_lng_sector,
             y = start_lat_sector, 
             xend = start_lng_sector + sign(x) * log10(abs(x))/250,
             yend = start_lat_sector + sign(y) * log10(abs(y))/250,
             color = angle)) +
  geom_sf(data = boundaries_chi, mapping = aes(), inherit.aes = FALSE) +
  geom_segment(arrow = arrow(length = unit(0.02, "npc")), size=1) +
  theme_map +
  theme(legend.position = "none") +
  scale_color_manual(values=c('#6B4EF3','#DC267F','#FF6100','#3FE205')) +  # colorblind-safe
  labs(subtitle = "Arrows show the average direction of traffic flow out of each region.\nLonger arrows mean a stronger tendency for traffic to flow that direction.",
       caption = "Andrew Luyt, 2021  |  Source: Divvy public data") +
  ylim(c(41.77, 42.01)) +
  xlim(c(-87.8, -87.57)) +
  transition_states(states = timecode, transition_length = 0, state_length = 1) +
  ggtitle("Divvy bike share, typical traffic flow: {next_state}") +
  shadow_wake(wake_length = 0.02, size = NULL)

FPS = 24; W = 600; H = 660; DTL = 2; NFRAMES = 6*24*3 # bins per hour * 24 hours * ()
animate(plot = p, fps = FPS, nframes = NFRAMES, detail=DTL, width=W, height=H)
anim_save("img/traffic-flow-sectored.mp4", p, fps = FPS, nframes = NFRAMES,
          detail = DTL, width=W, height=H,
          renderer = ffmpeg_renderer(options = list(b = "1200k")))
anim_save("img/traffic-flow-sectored.gif", p, fps = FPS, nframes = NFRAMES, 
          detail = DTL, width=W, height=H)
```

*Technical note: to calculate this metric, each trip is treated as a vector
from start station to end station.
All vectors in a particular period of time are added end-to-end and the final vector
is treated as the overall traffic flow.*

## Traffic flow patterns: showing all bike stations

```{r all traffic flow mapped fine detail, echo=FALSE, message=FALSE, warning=FALSE}
alltraffic_fine <- df %>% 
  filter(lubridate::wday(started_at) == 6) %>%
  mutate(minute = minute(started_at),
         minute = cut_interval(minute, n = 3, 
                               labels = c("00","20", "40")),
         started_at = 
           parse_date_time(paste0(lubridate::date(started_at), " ", 
                                  lubridate::hour(started_at), ":", minute),
                           "Ymd HM"),
         started_at = format(started_at, "%H:%M:%S")) %>% 
         # minute = cut_interval(minute, n = 6, 
         #                       labels = c("00","10","20","30","40","50"))) %>% 
  group_by(start_station_id) %>% 
  mutate(start_lng = mean(start_lng),
         start_lat = mean(start_lat)) %>% 
  group_by(started_at, start_lng, start_lat) %>%
  summarize(start_station_id = first(start_station_id),
            x = sum(trip_delta_x), 
            y = sum(trip_delta_y),
            magnitude = sqrt(x^2 + y^2),
            n_trips = n()) %>% 
  ungroup() %>% rowwise() %>% 
  mutate(angle = angle_from_x_axis(y,x)) %>% 
  ungroup() %>% 
  # bin angles into 4 quadrants: this maps well to the diagonals of average traffic flow
  # NB: The geom_segments don't use this variable, it's for colouring
  mutate(angle = cut_interval(angle, n = 4, labels = 1:4)) %>%  
  filter(n_trips > 2) %>%  # declutter map: remove rarely-used stations
  arrange(started_at, desc(angle)) #%>% 

# We'll log-transform the size of the motion vectors so the huge ones don't
# completely dominate
p <- 
  ggplot(alltraffic_fine, 
         aes(x = start_lng,
             y = start_lat, 
             xend = start_lng + sign(x) * log2(abs(x))/900,
             yend = start_lat + sign(y) * log2(abs(y))/900,
             color = angle,
             group = started_at)) +
  geom_sf(data = boundaries_chi, mapping = aes(), inherit.aes = FALSE, fill="grey95") +
  geom_segment(size=0.6, arrow = arrow(length = unit(0.007, "npc"))) +
  theme_map +
  theme(legend.position = "none") +
  scale_color_manual(values=c('#6B4EF3','#DC267F','#FF6100','#3FE205')) +  # colorblind-safe
  # scale_color_brewer(type = 'qual', palette = "Set1") +
  labs(subtitle = "Arrows show the average direction of traffic flow out of each station.\nLonger arrows mean a stronger tendency for traffic to flow that direction.",
       caption = "Andrew Luyt, 2021  |  Source: Divvy public data") +
  ylim(c(41.8, 42.0)) +
  xlim(c(-87.8, -87.55)) +
  transition_states(states = started_at, transition_length = 0, state_length = 4, wrap = TRUE) +
  ggtitle("Bike traffic flow on a typical Saturday: {next_state}") +
  #enter_fade()# + exit_fade()
  shadow_wake(wake_length = 0.04,  wrap = TRUE)


FPS = 30; W = 650; H = 680; DTL = 2; NFRAMES = 3*24*4 # bins per hour * 24 hours * (transition + state)
animate(plot = p, fps = FPS, nframes = NFRAMES, width=W, height=H, detail = DTL)
# anim_save("img/traffic-flow-detailed.mp4", p, fps = FPS, nframes = NFRAMES,
#           detail = DTL, width=W, height=H,
#           renderer = ffmpeg_renderer(options = list(b = "1200k")))
# anim_save("img/traffic-flow-detailed.gif", p, fps = FPS, nframes = NFRAMES, 
          # detail = DTL, width=W, height=H)
```

```{r all traffic flow mapped fine detail zoomed, echo=FALSE, message=FALSE, warning=FALSE}
alltraffic_finezoom <- df %>% 
  mutate(minute = minute(started_at),
         minute = cut_interval(minute, n = 6, 
                               labels = c("00","10","20","30","40","50"))) %>% 
  group_by(start_station_id) %>% 
  mutate(start_lng = mean(start_lng),
         start_lat = mean(start_lat)) %>% 
  group_by(start_lng,
           start_lat,
           timecode = paste0(sprintf("%02d", lubridate::hour(started_at)), ":",
                             minute)) %>%
  summarize(x = sum(trip_delta_x), 
            y = sum(trip_delta_y),
            magnitude = sqrt(x^2 + y^2),
            n_trips = n()) %>% 
  ungroup() %>% rowwise() %>% 
  mutate(angle = angle_from_x_axis(y,x)) %>% 
  ungroup() %>% 
  # bin angles into 4 quadrants: this maps well to the diagonals of average traffic flow
  # NB: The geom_segments don't use this variable, it's for colouring
  mutate(angle = cut_interval(angle, n = 4, labels = 1:4)) %>%  
  filter(n_trips > 1) %>%   # declutter map: remove rarely-used stations
  arrange(timecode, desc(angle))

# We'll log-transform the size of the motion vectors so the huge ones don't
# completely dominate
p <- 
  ggplot(alltraffic_finezoom, 
         aes(x = start_lng,
             y = start_lat, 
             xend = start_lng + sign(x) * log2(abs(x))/2400,
             yend = start_lat + sign(y) * log2(abs(y))/2400,
             color = angle)) +
  geom_sf(data = boundaries_chi, mapping = aes(), inherit.aes = FALSE) +
  geom_segment(size=0.9, arrow = arrow(length = unit(0.007, "npc"))) +
  theme_map +
  theme(legend.position = "none") +
  scale_color_manual(values=c('#6B4EF3','#DC267F','#FF6100','#3FE205')) +  # colorblind-safe
  labs(subtitle = "Arrows show the average direction of traffic flow out of each station.\nLonger arrows mean a stronger tendency for traffic to flow that direction.") +
  ylim(c(41.85, 41.95)) +
  xlim(c(-87.75, -87.6)) +
  transition_states(states = timecode, transition_length = 0, state_length = 3) +
  ggtitle("Divvy bike share, typical traffic flow: {next_state}") +
  shadow_wake(wake_length = 0.03,  wrap = TRUE)

# FPS = 24; W = 325; H = 340; NFRAMES = 6*24*3 # bins per hour * 24 hours * (transition + state)
FPS = 30; W = 650; H = 680; NFRAMES = 6*24*3 # bins per hour * 24 hours * (transition + state)
animate(plot = p, fps = FPS, nframes = NFRAMES, width=W, height=H)
anim_save("img/traffic-flow-zoom.mp4", p, fps = FPS, nframes = NFRAMES,
          width=W, height=H,
          renderer = ffmpeg_renderer(options = list(b = "1200k")))
anim_save("img/traffic-flow-zoom.gif", p, fps = FPS, nframes = NFRAMES, width=W, height=H)
```

```{r}
### show any warnings encountered during knitting
warnings()
```



