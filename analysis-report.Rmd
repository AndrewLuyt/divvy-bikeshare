---
title: "Analysis: How Casual Users and Members Differ"
author: "Andrew Luyt"
date: "2021-07-29"
output: 
  html_document:
    keep_md: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load data, include=FALSE}
library(tidyverse)
library(lubridate)
library(data.table)
library(sf)
library(here)
library(viridis)

Mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}

x.txt.size = 13  # scale the x axis ticks in many graphs

DATA = here("data/alldata.csv.gz")
df <- fread(
  DATA,
  colClasses = c(start_station_id = 'character',
                 end_station_id = 'character'),
  stringsAsFactors = TRUE,
  showProgress = FALSE
)

# put the factors in convenient order now, else we'll have to do this
# every time we make a plot using the weekday.
df <- df %>%
  mutate(
    weekday = fct_relevel(weekday,
                          c("Monday", "Tuesday", "Wednesday", "Thursday", 
                            "Friday", "Saturday", "Sunday")),
    month = fct_relevel(month, 
                        c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", 
                          "Aug", "Sep", "Oct", "Nov", "Dec")))

# Chicago neighbourhood boundaries as Simple Features. We only need
# the geometry for mapping, all the attributes can be discarded.
boundaries_chi = st_read(here("data/Chicago_Boundaries-Neighborhoods.geojson"),
                         quiet = TRUE)
boundaries_chi <- boundaries_chi %>%
  select(geometry)
```

## Executive Summary
Comparing casual users with members we find a few notable differences.

-todo

## Who rides most often?
Overall, members take the majority of rides. 

```{r who rides most often, echo=FALSE, message=FALSE, fig.width=7}
df %>% 
  group_by(member_casual) %>% 
  summarise(n = n()) %>% 
  ggplot(aes(x = member_casual, y = n, fill = member_casual)) +
  geom_col() +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Total number of rides",
       subtitle = paste("Since", lubridate::month(min(df$started_at), label = TRUE),
                        year(min(df$started_at))),
       x = NULL, y = "Rides") +
  geom_text(aes(label = scales::comma(n)), 
            vjust = 2.1,
            size = 5) +
  theme_bw() +
  theme(axis.text.x = element_text(size = x.txt.size),
        legend.position = "none")
```

On weekends however casual use doubles and even exceeds member use. 

```{r who rides most often 2, echo=FALSE, message=FALSE, fig.width=7}
df %>% 
  group_by(member_casual, weekday) %>% 
  summarise(n = n()) %>% 
  ggplot(aes(x = weekday, y = n, fill = member_casual)) +
  geom_col(position = "dodge") +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Total number of rides on each day of the week",
       subtitle = paste("Since", lubridate::month(min(df$started_at), label = TRUE),
                        year(min(df$started_at))),
       x = NULL, y = "Rides") +
  theme_bw() +
  theme(axis.text.x = element_text(),
        legend.title = element_blank())
```

Breaking down the number of rides by month, we can see that while the season
is important for all riders, casual users are much less willing to ride in
the winter months. From December to February, the system sees very little casual use.

```{r who rides most often 3, echo=FALSE, message=FALSE, fig.width=7}
df %>% 
  filter(started_at >= "2020-07-01") %>% 
  group_by(member_casual, month) %>% 
  summarise(n = n()) %>% 
  ggplot(aes(x = month, y = n, fill = member_casual)) +
  geom_col(position = "dodge") +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Total number of rides each month",
       subtitle = "Since July 2020",
       x = NULL, y = "Rides") +
  theme_bw() +
  theme(axis.text.x = element_text(),
        legend.title = element_blank())
```

**Summarizing the previous three graphs**, casual use of the system is much
more variable than for members. It is maximized
during summer weekends and minimized during winter weekdays.

## How do trip distances vary?

This is a bit surprising.  For trips that start and end at different stations,
the average trip is about the same distance for
both classes of users, two and a half kilometers.  

```{r avg trip distance, echo=FALSE, message=FALSE, fig.width=7}
df %>% 
  filter(is_round_trip == 'a to b') %>% 
  group_by(member_casual) %>% 
  summarise(mean_trip_distance = mean(trip_distance)) %>% 
  ggplot(aes(member_casual, mean_trip_distance, fill = member_casual)) +
  geom_col() +
  labs(title = "Average trip distance (Km)",
       subtitle = "Straight-line distance from start to end stations",
       x = NULL, y = "Kilometers") +
  geom_text(aes(label = round(mean_trip_distance, digits = 1)), 
            vjust = 2.1,
            size = 5) +
  theme_bw() +
  theme(legend.position = "none",
        axis.text.x = element_text(size = x.txt.size))
```

Seasonally, average trip distance is smallest during the winter and largest  
in summer, but only by about half a kilometer.
Trip distance does not change much over the course of the week.

### A special case: pleasure cruises?

For the above analysis we removed trips that start and end 
at the same station since they have an apparent distance of zero. We believe
it's likely that pleasure cruises make up a large portion of these rides.
These rides average an hour long for casual users.
In the 
next section on ride duration we'll see the average of all casual trips is just
over 30 minutes, an interesting difference.

```{r pleasure cruise caveat, echo=FALSE, message=FALSE, results='asis'}
df %>% 
  group_by(member_casual, is_round_trip) %>% 
  summarise(n_trips = n(), 
            avg_trip_minutes = round(mean(trip_minutes), 0)) %>% 
  mutate(percent_of_trips = n_trips / sum(n_trips) * 100) %>% 
  filter(is_round_trip == 'round trip') %>% 
  select(member_casual, n_trips, avg_trip_minutes, percent_of_trips) %>% 
  rename("Rider Type" = member_casual,
         "Possible pleasure cruises" = n_trips,
         "Avg trip minutes" = avg_trip_minutes,
         "Percent of trips" = percent_of_trips) %>% 
  knitr::kable()
```

These round-trips represent about 10% of 
all bike use and about 16% of all casual use. We also see above that casual 
users outnumber members 3 to 1 in this interesting subset of rides.  
We'll return to these trips in a later section, after we have explored
ride duration.

## How much *time* is spent on an average ride?
Casuals ride more than twice as long as members, on average.  There isn't
much variation in ride duration over the week other than a slight increase
on the weekend.

```{r mean ride duration, echo=FALSE}
df %>% 
  group_by(member_casual) %>% 
  summarise(mean_ride_length = mean(trip_minutes)) %>% 
  ggplot(aes(member_casual, mean_ride_length, fill = member_casual)) +
  geom_col() +
  labs(title = "Average ride duration (minutes)",
       x = NULL, y = "Minutes") +
  geom_text(aes(label = round(mean_ride_length, digits = 1)), 
            vjust = 2.1,
            size = 5) +
  theme_bw() +
  theme(legend.position = "none",
        axis.text.x = element_text(size = x.txt.size))
```

Seasonally, casual rides have a large amount of variation. The small number of
winter trips taken tend to be short - half the length of rides at the peak of summer.

```{r mean ride duration 2, echo=FALSE, message=FALSE}
df %>% 
  group_by(member_casual, month) %>% 
  summarise(mean_ride_length = mean(trip_minutes)) %>% 
  ggplot(aes(month, mean_ride_length, fill = member_casual)) +
  geom_col() +
  labs(title = "Average ride duration (minutes)",
       x = NULL, y = "Minutes") +
  geom_text(aes(label = round(mean_ride_length, digits = 0)), 
            vjust = 2.1,
            size = 4) +
  theme_bw() +
  theme(legend.position = "none",
        axis.text.x = element_text(size = x.txt.size))
```

## Pleasure cruises?

Earlier we noted the possibility that 10% of all rides (and 16% of casual
rides) were round-trip
pleasure cruises starting and ending at the same station, likely near the
rider's home. The two graphs below provide more evidence for this idea.

If our hypothesis is correct, the percentage of this type of ride should shrink
in winter and grow in summer and be mostly confined to casual users.  This
first graph shows exactly this pattern.

```{r pleasure cruises, echo=FALSE, message=FALSE}
df %>% 
  group_by(month, member_casual, is_round_trip) %>% 
  summarise(n = n()) %>% 
  mutate(percent_of_rides = n / sum(n) * 100) %>% 
  filter(is_round_trip == "round trip") %>%
  ggplot(aes(x = month, y = percent_of_rides, fill = member_casual)) +
  geom_col() +
  facet_wrap(~member_casual, ncol = 2) +
  labs(title = "Pleasure cruises over the seasons",
       subtitle = "Percentage of all trips starting and ending at the same station",
       x = NULL, y = "Percent of rides being round-trip") +
  theme_bw() +
  theme(legend.position = "none")
```

Second, if our idea is correct we should also see trip duration becoming longer
in summer and shorter in winter. This should strongly affect casual users but
have little effect on members, who have a 45-minute time limit.  This graph
demonstrates this pattern as well.

```{r pleasure cruises 2, echo=FALSE, message=FALSE}
df %>% 
  group_by(month, member_casual, is_round_trip) %>% 
  summarise(avg_ride_minutes = mean(trip_minutes)) %>% 
  filter(is_round_trip == "round trip") %>%
  ggplot(aes(x = month, y = avg_ride_minutes, fill = member_casual)) +
  geom_col() +
  facet_wrap(~member_casual, ncol = 2) +
  labs(title = "Duration of pleasure cruises",
       subtitle = "Seasonal variation is readily apparent",
       x = NULL, y = "Minutes") +
  theme_bw() +
  theme(legend.position = "none")
```

Learning how these rides differ in destination, length, or speed would require 
some sort of GPS tracking data from the bikes, which is outside the scope of 
this dataset.  For now we note the strong possibility that **about ten percent
of all trips are taken for enjoyment rather than travel, and that casual users
dominate this market segment.**

## Speed, Time in the Saddle, Comfort

We've seen that casuals and members ride about the same distances, but members
spend less time on the bikes. The graph below shows that members are about
30% faster on average.

```{r echo=FALSE}
df %>% 
  filter(is_round_trip == 'a to b') %>%  # round trips have a distance of 0
  mutate(kph = trip_distance / (trip_minutes / 60)) %>% 
  group_by(member_casual) %>% 
  summarise(mean_kph = mean(kph)) %>% 
  ggplot(aes(member_casual, mean_kph, fill = member_casual)) +
  geom_col() +
  labs(title = "Mean trip speed (Kph)",
       subtitle = "Members ride about 30% faster",
       x = NULL, y = "Kilometers per hour") +
  geom_text(aes(label = round(mean_kph, digits = 1)), 
            vjust = 2.1,
            size = 5) +
  theme_bw() +
  theme(legend.position = "none",
        axis.text.x = element_text(size = x.txt.size))
```

We now know that members ride more often and casuals ride longer: who rides the 
most total minutes?  Casual users do!

```{r echo=FALSE}
df %>% group_by(member_casual) %>% 
  summarise(total_minutes = sum(trip_minutes)) %>% 
  ggplot(aes(member_casual, total_minutes, fill= member_casual)) +
  geom_col() +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Who is in the saddle the longest?",
       subtitle=paste("Total minutes since", 
                      lubridate::month(min(df$started_at), label = TRUE),
                      year(min(df$started_at))),
       x = NULL,
       y = "Total Minutes") +
  stat_summary(fun = sum, 
               geom="text", 
               aes(label=scales::comma(total_minutes)), vjust = 2, size=5) +
  theme_bw() +
  theme(legend.position = "none", 
        axis.text.x = element_text(size=x.txt.size))
```

Since casual users spend so much more time in the saddle, it might be a
worthwhile experiment to trial a set of more comfortable, relaxed-ride bikes
aimed at users who want to cruise in comfort.  In the maps section below we
identify regions of the city where casual users dominate the ridership.

## Which stations do casuals use?

We'll look at this question in two parts.  **First** we'll examine who uses
the most and least popular stations.  **Second** we will plot these stations on a
map of Chicago.

### Station popularity

we'll sort the stations
by popularity (number of trips that start there) and colour the points by the
proportion of the type of user.
We can extract three main insights from the  graph below:

1. Overall, most stations are used primarily by members
1. The least popular stations are dominated by casual use
1. A few of the city's most popular stations are over 75% casual use
  - These might make excellent targets for any pilot programs targeting casual
  users

```{r station popularity and use, message=FALSE, echo=FALSE}
df %>% 
  group_by(start_station_id, member_casual) %>% 
  summarise(n = n()) %>% 
  mutate(total_trips = sum(n),
         p_casual = n / total_trips,
         mostly_casual = factor(p_casual > .5,
                                levels = c(TRUE, FALSE),
                                labels = c("Mostly casual", "Mostly members"))) %>% 
  filter(member_casual == 'casual') %>% 
  select(start_station_id, p_casual, total_trips, mostly_casual) %>% 
  arrange(total_trips) %>% 
  filter(total_trips > 100) %>% # remove nearly unused stations (some might be obsolete?)
  ggplot(aes(total_trips, p_casual)) +
  geom_point(aes(color = mostly_casual)) +
  geom_smooth(se = FALSE) +
  scale_x_log10(breaks = NULL, name = "(-)     Station Popularity     (+)") +
  scale_y_continuous(limits = c(0,1),labels = scales::percent) +
  annotate("text", x = 600, y = 0.95, 
           label = "Least popular") +
  annotate("text", x = 8000, y = 0.95, 
           label = "Most popular") +
  annotate("curve", x = 600, y = 0.9, xend = 140, yend=.8, curvature = -0.1,
           arrow = arrow(length = unit(0.04, "npc")),
           size = .7) +
  annotate("curve", x = 8000, y = 0.9, xend = 25000, yend=.75, curvature = 0.1,
           arrow = arrow(length = unit(0.04, "npc")),
           size = .7) +
  geom_hline(yintercept = 0.5, lty='dashed') +
  labs(title = "Station popularity and typical users",
       subtitle = "The least and most popular stations primarily casual use",
       y = "Casual use") +
  theme_bw() +
  theme(legend.title = element_blank())
```

Next we'll map all the bike stations in the system and colour them by the
percentage of casual rides that start there.

```{r mapping the dataset 8, echo=FALSE, message=FALSE, warning=FALSE}
# make a station density map
# create some convenient tibbles for mapping.
# Bike stations with location, trips, mean duration
stations <- df %>% 
  group_by(start_station_id, member_casual) %>% 
  summarise(start_station_name = Mode(start_station_name),
            station_lng = mean(start_lng),  # there is GPS error in coords
            station_lat = mean(start_lat),
            n_trips = n(),
            mean_duration = mean(trip_minutes)) %>% 
  filter(n_trips > 10)  # remove stations w/o enough data
# RECTANGULAR SECTORS which bin bike stations inside them
stations_sectored <- df %>% 
  group_by(start_lng_sector, start_lat_sector, member_casual) %>% 
  summarise(n_trips = n(),
            mean_duration = mean(trip_minutes)) %>% 
  filter(n_trips > 10)

# Finally, a tibble with casual user % at each station
# Sorting the data by p_trips_casual controls the order that dots are plotted
# in the map in the next code block. This is important because of overplotting.
# When stations are plotted in this order, the last stations to be plotted
# are on top. 
# The business task is to increase casual use, and this method ensures we 
# see the high casual use stations when the map is crowded. 
stations_users <- stations %>% 
  group_by(start_station_id) %>%
  mutate(p_trips_casual = n_trips / sum(n_trips),
         n_trips_station = sum(n_trips)) %>% 
  filter(member_casual == "casual") %>% 
  rename(n_trips_casual = n_trips) %>% 
  arrange(p_trips_casual)
```

```{r casual usage map, echo=FALSE, message=FALSE, warning=FALSE}
# Map station usage: colour stations by casual use percentage (ride start)
boundaries_chi %>% ggplot() +
  geom_sf() +
  geom_point(data = stations_users, 
             mapping = aes(x = station_lng, y = station_lat,
                           color = p_trips_casual)) +
  scale_color_viridis(option = "turbo", labels = scales::percent) +
  labs(title = "Casual usage at each station",
       color = "Casual use\n") +
  theme_bw() +
  theme(axis.title = element_blank(), 
        axis.text = element_blank(), 
        axis.ticks = element_blank(),
        panel.grid = element_blank(),)
```

Next let's highlight hot spots.  Any station with over 70% casual use will
be red, and we'll also give busier stations larger dots.

```{r casual usage map over 70, echo=FALSE, message=FALSE, warning=FALSE}
# Map the casual hot spots: stations over 75% casual use
boundaries_chi %>% ggplot() +
  geom_sf() +
  geom_point(data = stations_users, 
             mapping = aes(x = station_lng, y = station_lat, 
                           fill = p_trips_casual > .7,
                           size = n_trips_casual
                           ),
             color = "black",
             shape = 21) +
  scale_size_continuous(range = c(2, 9)) +
  scale_fill_discrete(type=c("deepskyblue4", "red")) +
  guides(fill = guide_legend(reverse = TRUE)) +  # reverse legend order, TRUE first
  labs(title = "Stations with over 70% casual use",
       subtitle = "Larger circles are busier stations",
       fill = "Over 70% casual use",
       size = "Number of trips") +
  theme_bw() +
  theme(axis.title = element_blank(), 
        axis.text = element_blank(), 
        axis.ticks = element_blank(),
        panel.grid = element_blank(),
        legend.position = "none")
```

Finally let's zoom in on notable hot spot near Navy Pier.  Of all stations with
over 70% casual use, these are the eight busiest.

```{r casual usage hot spot zoom, echo=FALSE, message=FALSE, warning=FALSE}
# Map the BUSY casual hot spots: stations over 75% casual use and > 5000 trips
NRIDES = 500
PCASUAL = 0.7
stations_users_busy <- stations %>% 
  filter(n_trips > NRIDES) %>% 
  group_by(start_station_id) %>%
  mutate(p_trips_casual = n_trips / sum(n_trips),
         n_trips_station = sum(n_trips)) %>% 
  filter(member_casual == "casual",
         p_trips_casual > PCASUAL) %>% 
  rename(n_trips_casual = n_trips) %>% 
  arrange(p_trips_casual)
```

## TODO: annotate map with what stations these are

```{r mapping the dataset 16, echo=FALSE, message=FALSE, warning=FALSE}
boundaries_chi %>% ggplot() +
  geom_sf() +
  geom_point(data = stations_users_busy, 
             mapping = aes(x = station_lng, y = station_lat,
                           size = n_trips_casual),
             fill = 'red',
             color = 'black',
             shape = 21) +
  scale_size_continuous(range = c(4, 10)) +
  labs(title = "The eight busiest casual use hot spots",
       size = "Number of trips") +
  ylim(c(41.86, 41.90)) +
  xlim(c(-87.67, -87.59)) +
  theme_bw() +
  theme(axis.title = element_blank(), 
        axis.text = element_blank(), 
        axis.ticks = element_blank(),
        panel.grid = element_blank(),
        legend.position = "none")
```

#### Which stations are these?

These stations are all around the waterfront between Soldier Field and
Navy Pier.

```{r hot spot list, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
stations_users_busy %>% 
  arrange(desc(n_trips_casual)) %>% 
  select(start_station_name, n_trips_casual, n_trips_station, p_trips_casual, station_lng, station_lat) %>% 
  head(n = 8) %>% 
  knitr::kable()
```

## Traffic Flow
In our last piece of analysis we will examine the overall traffic flow for
patterns exhibited by casual users.











