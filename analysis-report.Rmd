---
title: "Analysis: How Casual Users and Members Differ"
author: "Andrew Luyt"
date: "2021-07-29"
output: 
  html_document:
    keep_md: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r load data, include=FALSE}
library(tidyverse)
library(lubridate)
library(data.table)
library(sf)
library(here)
library(viridis)
library(ggrepel)
library(gganimate)

Mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}

# not vectorized, use rowwise()
# TODO: Vectorize.
angle_from_x_axis <- function(y,x) {
  angle <- atan2(y, x)
  if (y<0) {
    angle <- angle + 2 * pi
  } 
  angle * 180 / pi
}

Truncate <- function(x, ndigits = 1) {
  trunc(x*10^ndigits)/10^ndigits
}

# Normal 2-digit precision sectors were too small, 1-digits are too big.
# coord %% 2 == 1 --> 2x as wide & tall
Sector <- function(coord) {
  coord <- round(coord * 100, 0)
  indices <- coord %% 2 == 1
  coord[indices] <- 
    sign(coord[indices]) *
    (abs(coord[indices]) + 1)
  coord / 100
}

x.txt.size = 13  # scale the x axis ticks in many graphs

DATA = here("data/alldata.csv.gz")
df <- fread(
  DATA,
  colClasses = c(start_station_id = 'character',
                 end_station_id = 'character'),
  stringsAsFactors = TRUE,
  showProgress = FALSE
)

# put the factors in convenient order now, else we'll have to do this
# every time we make a plot using the weekday.
df <- df %>%
  mutate(
    weekday = fct_relevel(weekday,
                          c("Monday", "Tuesday", "Wednesday", "Thursday", 
                            "Friday", "Saturday", "Sunday")),
    month = fct_relevel(month, 
                        c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", 
                          "Aug", "Sep", "Oct", "Nov", "Dec")))

# Chicago neighbourhood boundaries as Simple Features. We only need
# the geometry for mapping, all the attributes can be discarded.
boundaries_chi = st_read(here("data/Chicago_Boundaries-Neighborhoods.geojson"),
                         quiet = TRUE)
boundaries_chi <- boundaries_chi %>%
  select(geometry)
```

```{r theming}
theme_set(theme_bw())
theme_update(panel.grid = element_blank())
```

## Executive Summary
Comparing casual users with members we find a few notable differences.

-todo

## Who rides most often?
Overall, members take the majority of rides. 

```{r who rides most often, echo=FALSE, message=FALSE, fig.width=7}
df %>% 
  group_by(member_casual) %>% 
  summarise(n = n()) %>% 
  ggplot(aes(x = member_casual, y = n, fill = member_casual)) +
  geom_col() +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Total number of rides",
       subtitle = paste("Since", lubridate::month(min(df$started_at), label = TRUE),
                        year(min(df$started_at))),
       x = NULL, y = "Rides") +
  geom_text(aes(label = scales::comma(n)), 
            vjust = 2.1,
            size = 5) +
  theme(axis.text.x = element_text(size = x.txt.size),
        legend.position = "none")
```

On weekends however casual use doubles and even exceeds member use. 

```{r who rides most often 2, echo=FALSE, message=FALSE, fig.width=7}
df %>% 
  group_by(member_casual, weekday) %>% 
  summarise(n = n()) %>% 
  ggplot(aes(x = weekday, y = n, fill = member_casual)) +
  geom_col(position = "dodge") +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Total number of rides on each day of the week",
       subtitle = paste("Since", lubridate::month(min(df$started_at), label = TRUE),
                        year(min(df$started_at))),
       x = NULL, y = "Rides") +
  theme(axis.text.x = element_text(),
        legend.title = element_blank())
```

Breaking down the number of rides by month, we can see that while the season
is important for all riders, casual users are much less willing to ride in
the winter months. From December to February, the system sees very little casual use.

```{r who rides most often 3, echo=FALSE, message=FALSE, fig.width=7}
df %>% 
  filter(started_at >= "2020-07-01") %>% 
  group_by(member_casual, month) %>% 
  summarise(n = n()) %>% 
  ggplot(aes(x = month, y = n, fill = member_casual)) +
  geom_col(position = "dodge") +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Total number of rides each month",
       subtitle = "Since July 2020",
       x = NULL, y = "Rides") +
  theme(legend.title = element_blank())
```

**Summarizing the previous three graphs**, casual use of the system is much
more variable than for members. It is maximized
during summer weekends and minimized during winter weekdays.

## How do trip distances vary?

This is a bit surprising.  For trips that start and end at different stations,
the average trip is about the same distance for
both classes of users, two and a half kilometers.  

```{r avg trip distance, echo=FALSE, message=FALSE, fig.width=7}
df %>% 
  filter(is_round_trip == 'a to b') %>% 
  group_by(member_casual) %>% 
  summarise(mean_trip_distance = mean(trip_distance)) %>% 
  ggplot(aes(member_casual, mean_trip_distance, fill = member_casual)) +
  geom_col() +
  labs(title = "Average trip distance (Km)",
       subtitle = "Straight-line distance from start to end stations",
       x = NULL, y = "Kilometers") +
  geom_text(aes(label = round(mean_trip_distance, digits = 1)), 
            vjust = 2.1,
            size = 5) +
  theme(legend.position = "none",
        axis.text.x = element_text(size = x.txt.size))
```

Seasonally, average trip distance is smallest during the winter and largest  
in summer, but only by about half a kilometer.
Trip distance does not change much over the course of the week.

### A special case: pleasure cruises?

For the above analysis we removed trips that start and end 
at the same station since they have an apparent distance of zero. We believe
it's likely that pleasure cruises make up a large portion of these rides.
These rides average an hour long for casual users.
In the 
next section on ride duration we'll see the average of all casual trips is just
over 30 minutes, an interesting difference.

```{r pleasure cruise caveat, results='asis'}
df %>% 
  group_by(member_casual, is_round_trip) %>% 
  summarise(n_trips = n(), 
            avg_trip_minutes = round(mean(trip_minutes), 0)) %>% 
  mutate(percent_of_trips = n_trips / sum(n_trips) * 100) %>% 
  filter(is_round_trip == 'round trip') %>% 
  select(member_casual, n_trips, avg_trip_minutes, percent_of_trips) %>% 
  rename("Rider Type" = member_casual,
         "Possible pleasure cruises" = n_trips,
         "Avg trip minutes" = avg_trip_minutes,
         "Percent of trips" = percent_of_trips) %>% 
  knitr::kable()
```

These round-trips represent about 10% of 
all bike use and about 16% of all casual use. We also see above that casual 
users outnumber members 3 to 1 in this interesting subset of rides.  
We'll return to these trips in a later section, after we have explored
ride duration.

## How much *time* is spent on an average ride?
Casuals ride more than twice as long as members, on average.  There isn't
much variation in ride duration over the week other than a slight increase
on the weekend.

```{r mean ride duration, echo=FALSE}
df %>% 
  group_by(member_casual) %>% 
  summarise(mean_ride_length = mean(trip_minutes)) %>% 
  ggplot(aes(member_casual, mean_ride_length, fill = member_casual)) +
  geom_col() +
  labs(title = "Average ride duration (minutes)",
       x = NULL, y = "Minutes") +
  geom_text(aes(label = round(mean_ride_length, digits = 1)), 
            vjust = 2.1,
            size = 5) +
  theme(legend.position = "none",
        axis.text.x = element_text(size = x.txt.size))
```

Seasonally, casual rides have a large amount of variation. The small number of
winter trips taken tend to be short - half the length of rides at the peak of summer.

```{r mean ride duration 2, echo=FALSE, message=FALSE}
df %>% 
  group_by(member_casual, month) %>% 
  summarise(mean_ride_length = mean(trip_minutes)) %>% 
  ggplot(aes(month, mean_ride_length, fill = member_casual)) +
  geom_col() +
  labs(title = "Average ride duration (minutes)",
       x = NULL, y = "Minutes") +
  geom_text(aes(label = round(mean_ride_length, digits = 0)), 
            vjust = 2.1,
            size = 4) +
  theme(legend.position = "none",
        axis.text.x = element_text(size = x.txt.size))
```

## Pleasure cruises?

Earlier we noted the possibility that 10% of all rides (and 16% of casual
rides) were round-trip
pleasure cruises starting and ending at the same station, likely near the
rider's home. The two graphs below provide more evidence for this idea.

If our hypothesis is correct, the percentage of this type of ride should shrink
in winter and grow in summer and be mostly confined to casual users.  This
first graph shows exactly this pattern.

```{r pleasure cruises, echo=FALSE, message=FALSE}
df %>% 
  group_by(month, member_casual, is_round_trip) %>% 
  summarise(n = n()) %>% 
  mutate(percent_of_rides = n / sum(n) * 100) %>% 
  filter(is_round_trip == "round trip") %>%
  ggplot(aes(x = month, y = percent_of_rides, fill = member_casual)) +
  geom_col() +
  facet_wrap(~member_casual, ncol = 2) +
  labs(title = "Pleasure cruises over the seasons",
       subtitle = "Percentage of all trips starting and ending at the same station",
       x = NULL, y = "Percent of rides being round-trip") +
  theme(legend.position = "none")
```

Second, if our idea is correct we should also see trip duration becoming longer
in summer and shorter in winter. This should strongly affect casual users but
have little effect on members, who have a 45-minute time limit.  This graph
demonstrates this pattern as well.

```{r pleasure cruises 2, echo=FALSE, message=FALSE}
df %>% 
  group_by(month, member_casual, is_round_trip) %>% 
  summarise(avg_ride_minutes = mean(trip_minutes)) %>% 
  filter(is_round_trip == "round trip") %>%
  ggplot(aes(x = month, y = avg_ride_minutes, fill = member_casual)) +
  geom_col() +
  facet_wrap(~member_casual, ncol = 2) +
  labs(title = "Duration of pleasure cruises",
       subtitle = "Seasonal variation is readily apparent",
       x = NULL, y = "Minutes") +
  theme(legend.position = "none")
```

Learning how these rides differ in destination, length, or speed would require 
some sort of GPS tracking data from the bikes, which is outside the scope of 
this dataset.  For now we note the strong possibility that **about ten percent
of all trips are taken for enjoyment rather than travel, and that casual users
dominate this market segment.**

## Speed, Time in the Saddle, Comfort

We've seen that casuals and members ride about the same distances, but members
spend less time on the bikes. The graph below shows that members are about
30% faster on average.

```{r mean trip speed}
df %>% 
  filter(is_round_trip == 'a to b') %>%  # round trips have a distance of 0
  mutate(kph = trip_distance / (trip_minutes / 60)) %>% 
  group_by(member_casual) %>% 
  summarise(mean_kph = mean(kph)) %>% 
  ggplot(aes(member_casual, mean_kph, fill = member_casual)) +
  geom_col() +
  labs(title = "Mean trip speed (Kph)",
       subtitle = "Members ride about 30% faster",
       x = NULL, y = "Kilometers per hour") +
  geom_text(aes(label = round(mean_kph, digits = 1)), 
            vjust = 2.1,
            size = 5) +
  theme(legend.position = "none",
        axis.text.x = element_text(size = x.txt.size))
```

We now know that members ride more often and casuals ride longer: who rides the 
most total minutes?  Casual users do!

```{r saddle time}
df %>% group_by(member_casual) %>% 
  summarise(total_minutes = sum(trip_minutes)) %>% 
  ggplot(aes(member_casual, total_minutes, fill= member_casual)) +
  geom_col() +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Who is in the saddle the longest?",
       subtitle=paste("Total minutes since", 
                      lubridate::month(min(df$started_at), label = TRUE),
                      year(min(df$started_at))),
       x = NULL,
       y = "Total Minutes") +
  stat_summary(fun = sum, 
               geom="text", 
               aes(label=scales::comma(total_minutes)), vjust = 2, size=5) +
  theme(legend.position = "none", 
        axis.text.x = element_text(size=x.txt.size))
```

Since casual users spend so much more time in the saddle, it might be a
worthwhile experiment to trial a set of more comfortable, relaxed-ride bikes
aimed at users who want to cruise in comfort.  In the maps section below we
identify regions of the city where casual users dominate the ridership.

## Which stations do casuals use?

We'll look at this question in two parts.  **First** we'll examine who uses
the most and least popular stations.  **Second** we will plot these stations on a
map of Chicago.

### Station popularity

we'll sort the stations
by popularity (number of trips that start there) and colour the points by the
proportion of the type of user.
We can extract three main insights from the  graph below:

1. Overall, most stations are used primarily by members
1. The least popular stations are dominated by casual use
1. A few of the city's most popular stations are over 75% casual use
  1. These might make excellent targets for any pilot programs targeting casual
  users

```{r station popularity and use}
df %>% 
  group_by(start_station_id, member_casual) %>% 
  summarise(n = n()) %>% 
  mutate(total_trips = sum(n),
         p_casual = n / total_trips,
         mostly_casual = factor(p_casual > .5,
                                levels = c(TRUE, FALSE),
                                labels = c("Mostly casual", "Mostly members"))) %>% 
  filter(member_casual == 'casual') %>% 
  select(start_station_id, p_casual, total_trips, mostly_casual) %>% 
  arrange(total_trips) %>% 
  filter(total_trips > 100) %>% # remove nearly unused stations (some might be obsolete?)
  ggplot(aes(total_trips, p_casual)) +
  geom_point(aes(color = mostly_casual)) +
  geom_smooth(se = FALSE) +
  scale_x_log10(breaks = NULL, name = "(Less)               Station Popularity               (More)") +
  scale_y_continuous(limits = c(0,1),labels = scales::percent) +
  annotate("text", x = 600, y = 0.95, 
           label = "Least popular") +
  annotate("text", x = 8000, y = 0.95, 
           label = "Most popular") +
  annotate("curve", x = 600, y = 0.9, xend = 140, yend=.85, curvature = -0.1,
           arrow = arrow(length = unit(0.03, "npc")),
           size = .7) +
  annotate("curve", x = 8000, y = 0.9, xend = 38000, yend=.85, curvature = 0.1,
           arrow = arrow(length = unit(0.03, "npc")),
           size = .7) +
  geom_hline(yintercept = 0.5, lty='dashed', col='gray30') +
  geom_vline(xintercept = 200, lty='dotted', col='gray30') +
  geom_vline(xintercept = 34000, lty='dotted', col='gray30') +
  labs(title = "Station popularity and typical users",
       subtitle = "The least and most popular stations are primarily casual use",
       y = "Casual use") +
  theme(legend.title = element_blank())
```

Next we'll map all the bike stations in the system and colour them by the
percentage of casual rides that start there.

```{r mapping the dataset 8}
# make a station density map
# create some convenient tibbles for mapping.
# Bike stations with location, trips, mean duration
stations <- df %>% 
  group_by(start_station_id, member_casual) %>% 
  summarise(start_station_name = Mode(start_station_name),
            station_lng = mean(start_lng),  # there is GPS error in coords
            station_lat = mean(start_lat),
            n_trips = n(),
            mean_duration = mean(trip_minutes)) %>% 
  filter(n_trips > 10)  # remove stations w/o enough data
# RECTANGULAR SECTORS which bin bike stations inside them
stations_sectored <- df %>% 
  group_by(start_lng_sector, start_lat_sector, member_casual) %>% 
  summarise(n_trips = n(),
            mean_duration = mean(trip_minutes)) %>% 
  filter(n_trips > 10)

# Finally, a tibble with casual user % at each station
# Sorting the data by p_trips_casual controls the order that dots are plotted
# in the map in the next code block. This is important because of overplotting.
# When stations are plotted in this order, the last stations to be plotted
# are on top. 
# The business task is to increase casual use, and this method ensures we 
# see the high casual use stations when the map is crowded. 
stations_users <- stations %>% 
  group_by(start_station_id) %>%
  mutate(p_trips_casual = n_trips / sum(n_trips),
         n_trips_station = sum(n_trips)) %>% 
  filter(member_casual == "casual") %>% 
  rename(n_trips_casual = n_trips) %>% 
  arrange(p_trips_casual)
```

```{r casual usage map, echo=FALSE, message=FALSE, warning=FALSE}
# Map station usage: colour stations by casual use percentage (ride start)
boundaries_chi %>% ggplot() +
  geom_sf() +
  geom_point(data = stations_users, 
             mapping = aes(x = station_lng, y = station_lat,
                           color = p_trips_casual)) +
  scale_color_viridis(option = "turbo", labels = scales::percent) +
  labs(title = "Casual usage at each station",
       color = "Casual use\n") +
  theme_bw() +
  theme(axis.title = element_blank(), 
        axis.text = element_blank(), 
        axis.ticks = element_blank(),
        panel.grid = element_blank(),)
```

Next let's highlight hot spots.  Any station with over 70% casual use will
be red, and we'll also give busier stations larger dots.

```{r casual usage map over 70}
# Map the casual hot spots: stations over 75% casual use
boundaries_chi %>% ggplot() +
  geom_sf() +
  geom_point(data = stations_users, 
             mapping = aes(x = station_lng, y = station_lat, 
                           fill = p_trips_casual > .7,
                           size = n_trips_casual,
                           shape = p_trips_casual > .7),
             color = "black") +
  scale_shape_manual(values = c(1,21)) +
  scale_size_continuous(range = c(2, 9)) +
  scale_fill_discrete(type=c("azure2", "red")) +
  guides(fill = guide_legend(reverse = TRUE)) +  # reverse legend order, TRUE first
  labs(title = "Stations with over 70% casual use are red",
       subtitle = "Larger circles are busier stations",
       fill = "Over 70% casual use",
       size = "Number of trips") +
  theme_bw() +
  theme(axis.title = element_blank(), 
        axis.text = element_blank(), 
        axis.ticks = element_blank(),
        panel.grid = element_blank(),
        legend.position = "none")
```

Finally let's zoom in on the notable hot spot near Navy Pier.  Of all stations with
over 70% casual use, these are the busiest.

```{r casual usage hot spot zoom, echo=FALSE, message=FALSE, warning=FALSE}
# Map the BUSY casual hot spots
NRIDES = 500
PCASUAL = 0.7
stations_users_busy <- stations %>% 
  filter(n_trips > NRIDES) %>% 
  group_by(start_station_id) %>%
  mutate(p_trips_casual = n_trips / sum(n_trips),
         n_trips_station = sum(n_trips)) %>% 
  filter(member_casual == "casual",
         p_trips_casual > PCASUAL) %>% 
  rename(n_trips_casual = n_trips) %>% 
  arrange(p_trips_casual)
```


```{r mapping the dataset 16, echo=FALSE, message=FALSE, warning=FALSE}
boundaries_chi %>% ggplot() +
  geom_sf() +
  geom_point(data = stations_users_busy, 
             mapping = aes(x = station_lng, y = station_lat,
                           size = n_trips_casual),
             fill = 'red',
             color = 'black',
             shape = 21) +
  geom_label_repel(data = stations_users_busy, 
            mapping = aes(x = station_lng, y = station_lat, label = start_station_name),
            nudge_x = -0.005,
            box.padding = .5) +
  scale_size_continuous(range = c(4, 10)) +
  scale_size_continuous(range = c(4, 10)) +
  labs(title = "Casual use hot spots on the waterfront",
       subtitle = "The most popular casual use destinations in Chicago",
       size = "Casual trips") +
  ylim(c(41.86, 41.90)) +
  xlim(c(-87.67, -87.59)) +
  theme_bw() +
  theme(axis.title = element_blank(), 
        axis.text = element_blank(), 
        axis.ticks = element_blank(),
        )
```

These stations are all on and around the waterfront between Soldier Field and
Navy Pier. They represent what is easily the most popular casual use desination
anywhere in the city, demonstrating a consistent pattern of activity by casual
users of the system.

## Traffic Flow: Hourly and daily patterns
In our last piece of analysis we will examine the overall traffic flow for
patterns

We calculate the overall traffic flow in the bike system. Each arrow represents
overall motion of all the bikes during a one-hour period.  An arrow pointing
northwest means that during that hour, bikes tend to be moving in that direction.
We'll use this to examine the difference in overall traffic flow over each hour 
in a week, comparing members vs casual users.

*Technical note: to calculate this metric, each trip is treated as a vector.
All vectors in a particular hour are added end-to-end and the final vector
is treated as the overall traffic flow.*

```{r create motion vectors day-of-week-hour, echo=FALSE, message=FALSE}
# day-of-the-week plus hour trends
dow_hour_vec <- df %>% 
  group_by(member_casual,
           weekday,
           hour = as_factor(lubridate::hour(started_at))) %>% 
  summarize(x = sum(trip_delta_x), 
            y = sum(trip_delta_y),
            mean_x = mean(trip_delta_x),
            mean_y = mean(trip_delta_y),
            magnitude = sqrt(x^2 + y^2)) %>% 
  rowwise() %>% 
  mutate(angle = angle_from_x_axis(y,x))

ggplot(dow_hour_vec, aes(x=0, y=0, xend=x, yend=y, color=hour)) +
  geom_hline(yintercept = 0, color = 'gray80') +
  geom_vline(xintercept = 0, color = 'gray80') +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_blank()) +
  geom_segment(arrow = arrow(length = unit(0.02, "npc")),  size=.8) +
  facet_wrap(~member_casual) +
  labs(title = "Overall traffic flow",
       subtitle = "Each arrow is the averaged traffic flow for one hour") +
  scale_color_viridis(discrete = TRUE, option="turbo")
```

Let's look at the members first, and the strong diagonal feature.
The blue-green arrows pointing southeast
show a strong trend in the morning hours for members to ride in that
direction. Recalling the early-morning spike in member traffic, these
arrows represent the morning rush hour.  The orange-red arrows pointing
northwest represent the evening commute.  The pattern for members is
very strong: the overall traffic flow is dominated by commuters and flows
diagonally across the city in two distinct periods.

For casual users the signal is weaker, showing that casual riders tend
to ride to more varied destinations.  Still, there is a clear distinction
shown by the colours: morning traffic trends east and afternoon & evening
traffic trends west.

Let's break this down further and split the trips into weekends vs weekdays.

```{r create motion vectors weekday-hour, fig.asp=.7, fig.height=8}
# day-of-the-week plus hour and weekend flag
wewd_hour_vec <- df %>% 
  group_by(member_casual,
           weekend_weekday,
           weekday,
           hour = as_factor(lubridate::hour(started_at))) %>% 
  summarize(x = sum(trip_delta_x), 
            y = sum(trip_delta_y),
            mean_x = mean(trip_delta_x),
            mean_y = mean(trip_delta_y),
            magnitude = sqrt(x^2 + y^2)) %>% 
  rowwise() %>% 
  mutate(angle = angle_from_x_axis(y,x))

ggplot(wewd_hour_vec, aes(x=0, y=0, xend=x, yend=y, color=hour)) +
  geom_hline(yintercept = 0, color = 'gray80') +
  geom_vline(xintercept = 0, color = 'gray80') +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_blank()) +
  geom_segment(arrow = arrow(length = unit(0.02, "npc")), size=.9) +
  facet_grid(cols = vars(member_casual),
             rows = vars(weekend_weekday)) +
  labs(title = "Overall traffic direction and strength",
       subtitle = "Each arrow is one hour on a particular day") +
  scale_color_viridis(discrete = TRUE, option="turbo")
```

Things become clearer. During the week, casual traffic follows a similar pattern
as members, suggesting that many of these trips are actually for commuting.

Next, let's examine casual traffic flow only.

```{r create motion vectors casual weekend-weekday, echo=FALSE, message=FALSE}
# hourly trends for weekday vs weekend
weekend_hour_vecs <- df %>% 
  group_by(member_casual,
           weekend_weekday,
           hour = as_factor(lubridate::hour(started_at))) %>% 
  summarize(x = sum(trip_delta_x), 
            y = sum(trip_delta_y),
            mean_x = mean(trip_delta_x),
            mean_y = mean(trip_delta_y),
            magnitude = sqrt(x^2 + y^2)) %>% 
  rowwise() %>% 
  mutate(angle = angle_from_x_axis(y,x))

weekend_hour_vecs %>% 
  filter(member_casual == 'casual') %>% 
  ggplot(aes(x=0, y=0, xend=x, yend=y, color=hour)) +
  geom_hline(yintercept = 0, color = 'gray80') +
  geom_vline(xintercept = 0, color = 'gray80') +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank()) +
  geom_segment(arrow = arrow(length = unit(0.02, "npc")), size=1) +
  facet_wrap(~weekend_weekday) +
  labs(title = "Casual traffic flow: weekday vs weekend",
       subtitle = "Each arrow is one hour of traffic") +
  scale_color_viridis(discrete = TRUE, option="turbo")
```

We see the commuting pattern during the weekdays, traveling mostly along
the northwest-southeast diagonal. 
On the weekend however, things are more interesting. Many casual trips are taken 
in the morning to early afternoon, traveling
northeast.  In the afternoon the traffic flow swings to
the west. Recalling our map of casual hot spots earlier, we suggest that a
majority of casual users are taking trips to the waterfront, spending some time there,
and then returning to their homes in the west.

As one last view, let's examine how these patterns evolve over a typical week.

```{r Traffic flow by hour and weekday faceted 2, echo=FALSE, message=FALSE}
ggplot(dow_hour_vec, aes(x=0, y=0, xend=x, yend=y, color=hour)) +
  geom_hline(yintercept = 0, color = 'gray80') +
  geom_vline(xintercept = 0, color = 'gray80') +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_blank()) +
  geom_segment(size=1.3) +
  facet_grid(rows = vars(member_casual),
             cols = vars(weekday)) +
  labs(title = "Traffic flow over the week: members vs casual users") +
  scale_color_viridis(discrete = TRUE, option="turbo")
```

```{r}
library(ggplot2)
library(gganimate)
library(gapminder)

animation <- ggplot(gapminder, aes(gdpPercap, lifeExp, size = pop, colour = country)) +
  geom_point(alpha = 0.7, show.legend = FALSE) +
  scale_colour_manual(values = country_colors) +
  scale_size(range = c(2, 12)) +
  scale_x_log10() +
  facet_wrap(~continent) +
  # Here comes the gganimate specific bits
  labs(title = 'Year: {frame_time}', x = 'GDP per capita', y = 'life expectancy') +
  transition_time(year) +
  ease_aes('linear') +
  shadow_wake(wake_length = 0.6)
animation
#anim_save("./img/gapminder.gif")
```

## All traffic flow
When we look at the overall traffic flow for the city, it is remarkably
consistent, day to day and between members and casuals.  Traffic flows in
to the waterfront from all directions, and flows out from the waterfront
either to the northwest or southwest, depending which side of Navy Pier
one is on.
```{r all traffic flow mapped sectored}
alltraffic <- df %>% 
  mutate(minute = minute(started_at),
         minute = cut_interval(minute, n = 6, 
                               labels = c("00","10","20","30","40","50"))) %>% 
  group_by(timecode = paste0(sprintf("%02d", lubridate::hour(started_at)), ":", minute),
           start_lng_sector = Sector(start_lng_sector), 
           start_lat_sector = Sector(start_lat_sector)) %>% 
  summarize(x = sum(trip_delta_x), 
            y = sum(trip_delta_y),
            mean_x = mean(trip_delta_x),
            mean_y = mean(trip_delta_y),
            magnitude = sqrt(x^2 + y^2)) %>% 
  ungroup() %>% rowwise() %>% 
  mutate(angle = angle_from_x_axis(y,x)) %>% 
  ungroup() %>% 
  mutate(angle = cut_interval(angle, n = 4, labels = 1:4)) %>%  # bin angles into 4 quadrants
  filter(magnitude >= 50) %>% # higher numbers make the map less cluttered
  arrange(timecode, desc(angle))

# We'll log-transform the size of the motion vectors so the huge ones don't
# completely dominate
p <- 
  ggplot(alltraffic, 
         aes(x = start_lng_sector,
             y = start_lat_sector, 
             xend = start_lng_sector + sign(x) * log10(abs(x))/250,
             yend = start_lat_sector + sign(y) * log10(abs(y))/250,
             color = angle)) +
  geom_sf(data = boundaries_chi, mapping = aes(), inherit.aes = FALSE) +
  # geom_point(aes(fill = angle), pch = 21, size=9.5, alpha = 0.8) +
  geom_segment(arrow = arrow(length = unit(0.02, "npc")), size=1) +
  theme(legend.position = "none",
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()) +
  scale_color_brewer(palette = "Set1") +
  labs(subtitle = "Arrows show the average direction of traffic flow out of each region") +
  ylim(c(41.77, 42.01)) +
  xlim(c(-87.8, -87.57)) +
  transition_states(states = timecode, transition_length = 0, state_length = 1) +
  ggtitle("Typical Divvy Traffic Flow: {next_state}") +
  shadow_wake(wake_length = 0.02, size = NULL)

FPS = 24; W = 600; H = 660; DTL = 2; NFRAMES = 6*24*3 # bins per hour * 24 hours * ()
animate(plot = p, fps = FPS, nframes = NFRAMES, detail=DTL, width=W, height=H)
anim_save("img/trafficflow-map-sectored.gif", p, fps = FPS, nframes = NFRAMES, detail=DTL, width=W, height=H)
```

## Typical traffic volume patterns
```{r all traffic volume mapped}
volume <- df %>% 
  select(started_at, start_station_id, start_lng, start_lat, member_casual) %>% 
  mutate(minute = minute(started_at),
         minute = cut_interval(minute, n = 6, 
                               labels = c("00","10","20","30","40","50"))) %>% 
  group_by(start_station_id) %>% 
  mutate(start_lng = mean(start_lng),
         start_lat = mean(start_lat)) %>% 
  group_by(start_station_id,
           timecode =
             paste0(sprintf("%02d", lubridate::hour(started_at)), ":",
                    minute),
           member_casual) %>% 
  summarise(n = n(),
            start_lng = first(start_lng),
            start_lat = first(start_lat)) %>% 
  mutate(total_trips = sum(n),
         p_casual = n / total_trips) %>% 
  filter(member_casual == "casual") %>% 
  mutate(mostly_casual = factor(p_casual > .5,
                                levels = c(TRUE, FALSE),
                                labels = c("Mostly casual", "Mostly members"))) %>% 
  # arrange(timecode, total_trips)  # for overplotting: last to be plotted are the largest # of trips
  # arrange(timecode, p_casual)  # for overplotting: last to be plotted are the highest casual %
  arrange(timecode, p_casual * total_trips)  # for overplotting: last to be plotted are largest # of casuals

# We'll log-transform the size of the motion vectors so the huge ones don't
# completely dominate
p <- 
  ggplot(volume, 
         aes(x = start_lng,
             y = start_lat,
             size = total_trips,
             fill = p_casual,
             color = p_casual)) +
  geom_sf(data = boundaries_chi, mapping = aes(), inherit.aes = FALSE) +
  # geom_point(pch = 21, color='black') +
  geom_point(pch = 21) +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()) +
  # scale_color_fermenter(palette = "Dark2", direction = -1, ) +
  scale_fill_distiller(palette = "RdYlBu", name = "Casual users", labels = scales::percent) +
  scale_color_distiller(palette = "RdYlBu", guide = FALSE) +  # turn off a legend with guide=FALSE
  # scale_fill_viridis(option = "viridis") +
  scale_size_continuous(range = c(1, 9), guide = FALSE) +
  labs(subtitle = "Red means a high percentage of casual users at a station, blue means users with\nDivvy memberships.   Larger circles mean more trips starting there.") +
  theme(legend.justification = "top") +
  # ylim(c(41.77, 42.01)) +
  # xlim(c(-87.8, -87.57)) +
  transition_states(states = timecode, transition_length = 0, state_length = 1, wrap = TRUE) +
  ggtitle("Typical Divvy Traffic Volume & User Type: {next_state}") +
  # enter_fade(alpha = 0.5)
  shadow_wake(wake_length = 0.025, wrap = TRUE, size = NULL)

animate(plot = p, fps = 24, nframes = 432, width=600, height=680)
# anim_save("img/traffic_volume_map.gif", p, fps = 22, nframes = 288)
```

```{r}
anim_save("img/traffic_volume_anim_1400k.mp4", p, fps = 24, nframes = 432, 
          width=600, height=680, 
          # renderer = av_renderer(framerate=24))
          renderer = ffmpeg_renderer(options = list(s = "600x680", # if you don't set size here in ffmpeg, vlc has issues with the file
                                                    b = "1400k")))
# anim_save("img/animation.mp4", p)
```

## Traffic flow patterns: showing all bike stations
```{r all traffic flow mapped fine detail, echo=FALSE, message=FALSE, warning=FALSE}
alltraffic_fine <- df %>% 
  mutate(minute = minute(started_at),
         minute = cut_interval(minute, n = 6, 
                               labels = c("00","10","20","30","40","50"))) %>% 
  group_by(start_station_id) %>% 
  mutate(start_lng = mean(start_lng),
         start_lat = mean(start_lat)) %>% 
  group_by(start_lng,
           start_lat,
           timecode =
             paste0(sprintf("%02d", lubridate::hour(started_at)), ":",
                    minute)) %>%
  summarize(x = sum(trip_delta_x), 
            y = sum(trip_delta_y),
            magnitude = sqrt(x^2 + y^2)) %>% 
  ungroup() %>% rowwise() %>% 
  mutate(angle = angle_from_x_axis(y,x)) %>% 
  ungroup() %>% 
  # bin angles into 4 quadrants: this maps well to the diagonal directions of average traffic flow
  # NB: The geom_segments don't use this variable
  mutate(angle = cut_interval(angle, n = 4, labels = 1:4)) %>%  
  filter(magnitude >= 10) %>%  # higher numbers make the map less cluttered
  arrange(timecode, desc(angle)) #%>% 
  # slice(4000:10000)

# We'll log-transform the size of the motion vectors so the huge ones don't
# completely dominate
p <- 
  ggplot(alltraffic_fine, 
         aes(x = start_lng,
             y = start_lat, 
             xend = start_lng + sign(x) * log2(abs(x))/1500,
             yend = start_lat + sign(y) * log2(abs(y))/1500,
             color = angle)) +
  geom_sf(data = boundaries_chi, mapping = aes(), inherit.aes = FALSE) +
  geom_segment(size=0.7, arrow = arrow(length = unit(0.005, "npc"))) +
  theme(legend.position = "none",
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()) +
  # scale_color_viridis(option = "turbo", discrete = TRUE, begin = 0.02) +
  scale_color_brewer(palette = "Set1") +
  labs(subtitle = "Arrows show the average direction of traffic flow out of each station") +
  ylim(c(41.77, 42.01)) +
  xlim(c(-87.9, -87.51)) +
  transition_states(states = timecode, transition_length = 0, state_length = 3) +
  ggtitle("Typical Divvy Traffic Flow: {next_state}") +
  # enter_fade(alpha = .1)
  # shadow_mark(future=TRUE)
  # enter_grow(size = .2) 
  shadow_wake(wake_length = 0.03,  wrap = TRUE)

FPS = 24; W = 650; H = 720; NFRAMES = 6*24*3 # bins per hour * 24 hours * (transition + state)
# animate(plot = p, fps = FPS, nframes = NFRAMES, width=W, height=H)  
# animate(plot = p, fps = FPS, nframes = 6*24*2, width=800, height=1000, renderer = av_renderer("anim.mp4")) # bins/hour * 24 hours 
anim_save("img/trafficflow-map-detailed.gif", p, fps = FPS, nframes = NFRAMES, width=W, height=H)

```



```{r}
# anim_save("img/animation.mp4", p)
```


















